<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Prof. Sterling | Pro English Tutor</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root {
            --bg-color: #0f172a;
            --chat-bg: #1e293b;
            --primary: #3b82f6;
            --primary-glow: rgba(59, 130, 246, 0.5);
            --secondary: #64748b;
            --accent: #0ea5e9;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --success: #10b981;
            --error: #ef4444;
            --user-msg-bg: #2563eb;
            --bot-msg-bg: #334155;
            
            --radius-md: 16px;
            --radius-lg: 24px;
            --shadow-glow: 0 0 20px rgba(59, 130, 246, 0.15);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Outfit', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- Header --- */
        .header {
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(10px);
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            z-index: 10;
        }

        .profile-group {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .avatar-wrapper {
            position: relative;
        }

        .avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--primary);
            box-shadow: 0 0 15px var(--primary-glow);
        }

        .status-dot {
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 12px;
            height: 12px;
            background: var(--success);
            border: 2px solid var(--bg-color);
            border-radius: 50%;
        }

        .tutor-info h1 {
            font-size: 1.1rem;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .tutor-info p {
            font-size: 0.8rem;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .settings-btn {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            color: var(--text-main);
            width: 40px;
            height: 40px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .settings-btn:hover { background: rgba(255,255,255,0.1); transform: rotate(45deg); }

        /* --- Chat Area --- */
        .chat-area {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            scroll-behavior: smooth;
            padding-bottom: 180px; /* Space for input area */
        }

        /* Message Bubbles */
        .message {
            display: flex;
            gap: 1rem;
            max-width: 95%;
            animation: slideIn 0.3s ease-out;
        }

        .message.user {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .message.bot {
            align-self: flex-start;
        }

        .msg-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            object-fit: cover;
            flex-shrink: 0;
            margin-top: 5px;
        }

        .msg-content {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            min-width: 0; /* Fix flex overflow */
        }

        .msg-bubble {
            padding: 1rem 1.2rem;
            border-radius: var(--radius-md);
            font-size: 0.95rem;
            line-height: 1.6;
            position: relative;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .user .msg-bubble {
            background: var(--user-msg-bg);
            color: white;
            border-radius: var(--radius-lg) var(--radius-lg) 0 var(--radius-lg);
        }

        .bot .msg-bubble {
            background: var(--bot-msg-bg);
            color: var(--text-main);
            border-radius: 0 var(--radius-lg) var(--radius-lg) var(--radius-lg);
        }

        /* Corrections Section */
        .correction-box {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 12px;
            padding: 0.8rem 1rem;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            backdrop-filter: blur(5px);
        }

        .correction-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--error);
            font-weight: 600;
            font-size: 0.8rem;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .diff-error {
            color: #fca5a5;
            text-decoration: line-through;
            opacity: 0.8;
            display: block;
            margin-bottom: 0.3rem;
        }

        .diff-correct {
            color: var(--success);
            font-weight: 500;
            display: block;
        }
        
        .diff-explanation {
            margin-top: 0.5rem;
            font-size: 0.8rem;
            color: var(--text-muted);
            border-top: 1px solid rgba(255,255,255,0.1);
            padding-top: 0.4rem;
        }

        /* --- Input Area --- */
        .input-container {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(15px);
            padding: 1.5rem;
            border-top: 1px solid rgba(255,255,255,0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            z-index: 20;
        }

        .mic-button {
            width: 72px;
            height: 72px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 0 20px var(--primary-glow);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .mic-button:active { transform: scale(0.95); }
        .mic-button.listening { 
            background: var(--error); 
            box-shadow: 0 0 30px rgba(239, 68, 68, 0.4);
            animation: pulse 1.5s infinite;
        }

        .status-text {
            font-size: 0.9rem;
            color: var(--text-muted);
            font-weight: 500;
            min-height: 20px;
        }

        /* --- Modal --- */
        .modal-backdrop {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            z-index: 100;
        }
        .modal-backdrop.active { opacity: 1; pointer-events: all; }

        .modal-content {
            background: var(--chat-bg);
            width: 90%;
            max-width: 450px;
            border-radius: 20px;
            padding: 2rem;
            border: 1px solid rgba(255,255,255,0.1);
            transform: translateY(20px);
            transition: transform 0.3s;
        }
        .modal-backdrop.active .modal-content { transform: translateY(0); }

        .form-label { display: block; margin-bottom: 0.5rem; color: var(--text-muted); font-size: 0.9rem; }
        .form-input, .form-select {
            width: 100%;
            padding: 0.8rem;
            background: rgba(0,0,0,0.2);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 10px;
            color: white;
            font-family: inherit;
            margin-bottom: 1.5rem;
        }
        .form-select option { background: var(--chat-bg); }

        .save-btn {
            width: 100%;
            padding: 1rem;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
        }

        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
        
        /* Mobile fixes */
        @media (max-width: 400px) {
            .chat-area { padding: 1rem; }
            .msg-bubble { padding: 0.8rem 1rem; font-size: 0.9rem; }
        }
    </style>
</head>
<body>

    <header class="header">
        <div class="profile-group">
            <div class="avatar-wrapper">
                <img src="https://images.unsplash.com/photo-1500648767791-00dcc994a43e?ixlib=rb-4.0.3&auto=format&fit=crop&w=200&q=80" alt="Tutor" class="avatar">
                <div class="status-dot"></div>
            </div>
            <div class="tutor-info">
                <h1>Prof. Sterling</h1>
                <p><i class="fas fa-graduation-cap"></i> AI English Tutor</p>
            </div>
        </div>
        <button class="settings-btn" id="settingsBtn"><i class="fas fa-sliders-h"></i></button>
    </header>

    <div class="chat-area" id="chatArea">
        <!-- Messages will appear here -->
        <div class="message bot">
            <img src="https://images.unsplash.com/photo-1500648767791-00dcc994a43e?ixlib=rb-4.0.3&auto=format&fit=crop&w=200&q=80" class="msg-avatar">
            <div class="msg-content">
                <div class="msg-bubble">
                    Hello there! I'm Sterling. I'm here to have a conversation with you and help you perfect your English.
                    <br><br>
                    I will detecting your mistakes, correcting them, and explaining why. What would you like to talk about today?
                </div>
            </div>
        </div>
    </div>

    <div class="input-container">
        <div class="status-text" id="statusText">Press and hold to speak</div>
        <button class="mic-button" id="micBtn">
            <i class="fas fa-microphone"></i>
        </button>
    </div>

    <!-- Settings Modal -->
    <div class="modal-backdrop" id="modalBackdrop">
        <div class="modal-content">
            <h2 style="margin-bottom: 1.5rem;">Settings</h2>
            
            <label class="form-label">Gemini API Key (Required for AI)</label>
            <input type="password" class="form-input" id="apiKeyInput" placeholder="Enter your key...">

            <label class="form-label">Voice Selection</label>
            <select class="form-select" id="voiceSelect">
                <option value="auto">Auto-Detect Male Voice</option>
            </select>

            <label class="form-label">Speaking Rate</label>
            <input type="range" class="form-input" id="rateInput" min="0.5" max="1.5" step="0.1" value="1.0">

            <button class="save-btn" id="saveBtn">Save Changes</button>
            <p style="margin-top: 1rem; font-size: 0.8rem; color: var(--text-muted); text-align: center;" id="modalClose">Close</p>
        </div>
    </div>

    <script>
        // --- Logic Core ---
        const UI = {
            chatArea: document.getElementById('chatArea'),
            micBtn: document.getElementById('micBtn'),
            statusText: document.getElementById('statusText'),
            modal: document.getElementById('modalBackdrop'),
            settingsBtn: document.getElementById('settingsBtn'),
            saveBtn: document.getElementById('saveBtn'),
            modalClose: document.getElementById('modalClose'),
            apiKeyInput: document.getElementById('apiKeyInput'),
            voiceSelect: document.getElementById('voiceSelect'),
            rateInput: document.getElementById('rateInput')
        };

        const STATE = {
            isRecording: false,
            apiKey: localStorage.getItem('gemini_key') || '',
            voices: [],
            selectedVoiceIndex: -1,
            rate: 1.0,
            conversationHistory: [] // To keep context
        };

        // --- Speech Recognition ---
        const Recognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition;

        if (Recognition) {
            recognition = new Recognition();
            recognition.continuous = false;
            recognition.lang = 'en-US';
            recognition.interimResults = false;

            recognition.onstart = () => {
                STATE.isRecording = true;
                UI.micBtn.classList.add('listening');
                UI.statusText.innerText = "Listening...";
            };

            recognition.onend = () => {
                STATE.isRecording = false;
                UI.micBtn.classList.remove('listening');
                UI.statusText.innerText = "Processing...";
            };

            recognition.onresult = (event) => {
                const text = event.results[0][0].transcript;
                handleUserInput(text);
            };
        } else {
            UI.statusText.innerText = "Speech API not supported.";
        }

        // --- Interaction Handlers ---
        UI.micBtn.addEventListener('mousedown', startListening);
        UI.micBtn.addEventListener('touchstart', (e) => { e.preventDefault(); startListening(); });
        
        UI.micBtn.addEventListener('mouseup', stopListening);
        UI.micBtn.addEventListener('touchend', stopListening);

        function startListening() {
            if (speechSynthesis.speaking) speechSynthesis.cancel();
            try { recognition.start(); } catch(e) { console.log(e); }
        }

        function stopListening() {
            try { recognition.stop(); } catch(e) { console.log(e); }
        }

        async function handleUserInput(text) {
            addMessage(text, 'user');
            
            // Show loading bubble
            const loadingId = addLoadingBubble();

            try {
                let data;
                if (STATE.apiKey) {
                    data = await callGemini(text);
                } else {
                    data = fallbackLogic(text); // Simula inteligencia si no hay key
                }

                removeMessage(loadingId);
                
                // Display Correction if exists
                if (data.correction) {
                    addCorrectionMessage(data.correction);
                }

                // Display Response
                addMessage(data.response, 'bot');

                // Speak
                let speechText = data.response;
                if (data.correction) {
                    // Say correction first
                    speechText = `Actually, instead of "${data.correction.mistake}", it is better to say "${data.correction.fix}". ${data.response}`;
                }
                speak(speechText);

            } catch (error) {
                removeMessage(loadingId);
                addMessage("I'm having trouble connecting to my brain. Please check your API Key in settings.", 'bot');
            }
        }

        // --- Gemini API (The Brain) ---
        async function callGemini(userText) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${STATE.apiKey}`;
            
            // Build history context
            const historyText = STATE.conversationHistory.slice(-4).map(m => `${m.role}: ${m.text}`).join('\n');

            const systemPrompt = `
                You are Professor Sterling, a male English tutor. 
                Your goal is to have a natural conversation while correcting grammar errors.
                
                1. ANALYZE the user's input: "${userText}"
                2. CONTEXT of chat: \n${historyText}
                3. OUTPUT must be a raw JSON object (no markdown) with this structure:
                {
                    "correction": null or {
                        "mistake": "the part of user text with error",
                        "fix": "the corrected version",
                        "explanation": "brief reason why"
                    },
                    "response": "A natural, engaging reply (max 2 sentences) to continue the conversation."
                }
                
                If the input is perfect English, "correction" should be null.
                If there is a grammar, vocabulary, or naturalness error, fill the correction object.
                Ignore punctuation errors unless severe.
            `;

            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: systemPrompt }] }]
                })
            });

            const raw = await response.json();
            let textResponse = raw.candidates[0].content.parts[0].text;
            
            // Clean markdown if present
            textResponse = textResponse.replace(/```json/g, '').replace(/```/g, '').trim();
            
            const jsonResponse = JSON.parse(textResponse);
            
            // Save context
            STATE.conversationHistory.push({ role: 'User', text: userText });
            STATE.conversationHistory.push({ role: 'Sterling', text: jsonResponse.response });

            return jsonResponse;
        }

        // --- Fallback Logic (Simulated Intelligence) ---
        function fallbackLogic(text) {
            const lower = text.toLowerCase();
            let correction = null;
            let response = "That's interesting! Tell me more.";

            // Expanded Regex Rules for common mistakes
            const rules = [
                { match: /\b(he|she|it) don't\b/, fix: "$1 doesn't", expl: "Third person singular uses 'doesn't'." },
                { match: /\b(I|you|we|they) has\b/, fix: "$1 have", expl: "With I/You/We/They, use 'have'." },
                { match: /\bI am agree\b/, fix: "I agree", expl: "'Agree' is a verb, so you don't need 'am'." },
                { match: /\bpeople is\b/, fix: "people are", expl: "'People' is plural." },
                { match: /\bmuch (people|friends|chairs)\b/, fix: "many $1", expl: "Use 'many' for countable nouns." },
                { match: /\blisten music\b/, fix: "listen to music", expl: "We always say 'listen to' something." },
                { match: /\bmarried with\b/, fix: "married to", expl: "In English, you are married 'to' someone." },
                { match: /\bI am boring\b/, fix: "I am bored", expl: "If you feel it, you are 'bored'. If something causes it, it is 'boring'." }
            ];

            for (let r of rules) {
                if (r.match.test(lower)) {
                    correction = {
                        mistake: text.match(r.match)[0],
                        fix: text.replace(r.match, r.fix), // Simple text replace for demo
                        explanation: r.expl
                    };
                    break;
                }
            }

            // Keyword Context
            if (lower.includes('hello') || lower.includes('hi')) response = "Hello! I'm ready to help you practice.";
            else if (lower.includes('name')) response = "My name is Sterling. What's yours?";
            else if (lower.includes('music')) response = "I love music. What's your favorite genre?";
            else if (lower.includes('football') || lower.includes('soccer')) response = "Sports are a great topic. Do you play any?";
            else if (lower.includes('food') || lower.includes('eat')) response = "Talking about food makes me hungry. What's your favorite dish?";
            
            // Fallback warning
            if (!STATE.apiKey) {
                response += " (Note: Add API Key in settings for real intelligence and full error detection).";
            }

            return { correction, response };
        }

        // --- UI Rendering ---
        function addMessage(text, type) {
            const div = document.createElement('div');
            div.className = `message ${type}`;
            const avatarUrl = type === 'bot' 
                ? 'https://images.unsplash.com/photo-1500648767791-00dcc994a43e?ixlib=rb-4.0.3&auto=format&fit=crop&w=200&q=80'
                : 'https://cdn-icons-png.flaticon.com/512/847/847969.png'; // Generic user icon
            
            div.innerHTML = `
                <img src="${avatarUrl}" class="msg-avatar">
                <div class="msg-content">
                    <div class="msg-bubble">${marked.parse(text)}</div>
                </div>
            `;
            UI.chatArea.appendChild(div);
            div.scrollIntoView({ behavior: 'smooth' });
        }

        function addCorrectionMessage(data) {
            const div = document.createElement('div');
            div.className = 'message bot'; // Bot correction
            div.innerHTML = `
                <img src="https://images.unsplash.com/photo-1500648767791-00dcc994a43e?ixlib=rb-4.0.3&auto=format&fit=crop&w=200&q=80" class="msg-avatar">
                <div class="msg-content">
                    <div class="correction-box">
                        <div class="correction-header"><i class="fas fa-tools"></i> Correction</div>
                        <span class="diff-error">"${data.mistake}"</span>
                        <span class="diff-correct">"${data.fix}"</span>
                        <div class="diff-explanation">${data.explanation}</div>
                    </div>
                </div>
            `;
            UI.chatArea.appendChild(div);
        }

        function addLoadingBubble() {
            const id = 'loading-' + Date.now();
            const div = document.createElement('div');
            div.id = id;
            div.className = 'message bot';
            div.innerHTML = `
                <img src="https://images.unsplash.com/photo-1500648767791-00dcc994a43e?ixlib=rb-4.0.3&auto=format&fit=crop&w=200&q=80" class="msg-avatar">
                <div class="msg-content">
                    <div class="msg-bubble" style="color:var(--text-muted); font-style:italic;">
                        <i class="fas fa-circle-notch fa-spin"></i> Thinking...
                    </div>
                </div>
            `;
            UI.chatArea.appendChild(div);
            div.scrollIntoView({ behavior: 'smooth' });
            return id;
        }

        function removeMessage(id) {
            const el = document.getElementById(id);
            if (el) el.remove();
        }

        // --- TTS Engine (Voice) ---
        function loadVoices() {
            STATE.voices = speechSynthesis.getVoices();
            UI.voiceSelect.innerHTML = '<option value="auto">Auto-Detect Male Voice</option>';
            
            STATE.voices.forEach((voice, index) => {
                const opt = document.createElement('option');
                opt.value = index;
                opt.text = `${voice.name} (${voice.lang})`;
                UI.voiceSelect.appendChild(opt);
            });
        }
        speechSynthesis.onvoiceschanged = loadVoices;

        function speak(text) {
            speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            
            // Voice Selection Logic
            if (UI.voiceSelect.value === 'auto') {
                // Smart auto-detect logic for male voices
                const preferred = [
                    "Google US English", "Microsoft David", "Microsoft Guy", "Daniel", "Google UK English Male"
                ];
                let selected = STATE.voices.find(v => preferred.some(p => v.name.includes(p)));
                
                // If no premium male voice found, try to find ANY male voice
                if (!selected) {
                    selected = STATE.voices.find(v => v.name.toLowerCase().includes('male') && v.lang.startsWith('en'));
                }
                // Fallback to any English voice
                if (!selected) {
                    selected = STATE.voices.find(v => v.lang.startsWith('en'));
                }
                
                if (selected) utterance.voice = selected;
                // Pitch tweak for "masculine" feel if fallback is generic
                utterance.pitch = 0.9; 
            } else {
                utterance.voice = STATE.voices[parseInt(UI.voiceSelect.value)];
                utterance.pitch = 1.0; // Use natural pitch of selected voice
            }

            utterance.rate = STATE.rate;
            speechSynthesis.speak(utterance);
        }

        // --- Settings Modal ---
        UI.settingsBtn.onclick = () => UI.modal.classList.add('active');
        UI.modalClose.onclick = () => UI.modal.classList.remove('active');
        
        UI.saveBtn.onclick = () => {
            STATE.apiKey = UI.apiKeyInput.value;
            STATE.rate = parseFloat(UI.rateInput.value);
            localStorage.setItem('gemini_key', STATE.apiKey);
            UI.modal.classList.remove('active');
            addMessage("Settings saved. " + (STATE.apiKey ? "AI Brain Active." : "Using Basic Mode."), 'bot');
        };

        // Init
        UI.apiKeyInput.value = STATE.apiKey;
        loadVoices();
        
    </script>
</body>
</html>
