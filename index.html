<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prof. Alex - AI English Tutor</title>
    <!-- Tailwind CSS para diseño moderno -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome para iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        primary: '#2563EB', // Azul moderno
                        secondary: '#F3F4F6',
                        success: '#10B981',
                        error: '#EF4444',
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'wave': 'wave 1.2s ease-in-out infinite',
                    },
                    keyframes: {
                        wave: {
                            '0%, 100%': { height: '10px' },
                            '50%': { height: '24px' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* Estilos personalizados para scrollbar y detalles finos */
        body {
            background-color: #ffffff;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .chat-container {
            flex: 1;
            overflow-y: auto;
            scroll-behavior: smooth;
            padding-bottom: 140px; /* Espacio aumentado para el footer más alto */
        }

        .chat-container::-webkit-scrollbar {
            width: 6px;
        }
        .chat-container::-webkit-scrollbar-thumb {
            background-color: #E5E7EB;
            border-radius: 3px;
        }

        /* Animación de ondas de sonido */
        .sound-wave-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            height: 30px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .sound-wave-container.active {
            opacity: 1;
        }
        .bar {
            width: 4px;
            background-color: #10B981; /* Verde cuando graba */
            border-radius: 2px;
            animation: wave 1s ease-in-out infinite;
        }
        .bar:nth-child(2) { animation-delay: 0.1s; }
        .bar:nth-child(3) { animation-delay: 0.2s; }
        .bar:nth-child(4) { animation-delay: 0.3s; }
        .bar:nth-child(5) { animation-delay: 0.4s; }

        /* Botón de micrófono pulsante */
        .mic-button-shadow {
            box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
            animation: pulse-green 2s infinite;
        }
        @keyframes pulse-green {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 20px rgba(16, 185, 129, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- Header -->
    <header class="bg-white border-b border-gray-100 p-4 flex items-center justify-between sticky top-0 z-10 shadow-sm">
        <div class="flex items-center gap-3">
            <div class="relative">
                <img src="https://randomuser.me/api/portraits/men/32.jpg" alt="Prof. Alex" class="w-12 h-12 rounded-full object-cover border-2 border-white shadow-md">
                <div class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 rounded-full border-2 border-white"></div>
            </div>
            <div>
                <h1 class="font-bold text-lg text-gray-900 leading-tight">Prof. Alex</h1>
                <p class="text-xs text-blue-600 font-medium">AI English Tutor</p>
            </div>
        </div>
        <button id="settingsBtn" class="text-gray-400 hover:text-gray-600 transition p-2">
            <i class="fa-solid fa-gear text-xl"></i>
        </button>
    </header>

    <!-- Chat Area -->
    <main id="chatArea" class="chat-container p-4 bg-gray-50">
        <!-- Mensaje de bienvenida -->
        <div class="flex gap-3 mb-6 animate-fade-in">
            <img src="https://randomuser.me/api/portraits/men/32.jpg" class="w-8 h-8 rounded-full self-start mt-1">
            <div class="flex flex-col max-w-[85%]">
                <div class="bg-white p-4 rounded-2xl rounded-tl-none shadow-sm border border-gray-100 text-gray-700">
                    <p>Hello! I'm Prof. Alex. Tap the microphone to start speaking. Take your time, and tap the Send button when you are done.</p>
                </div>
                <!-- Botón de traducción -->
                <button onclick="translateText('Hello! I\'m Prof. Alex...')" class="self-end mt-1 text-xs text-gray-400 hover:text-blue-500 flex items-center gap-1 bg-white px-2 py-1 rounded-full border border-gray-100 shadow-sm transition-all">
                    <i class="fa-solid fa-language"></i> Traducir
                </button>
            </div>
        </div>
    </main>

    <!-- Footer / Input Area -->
    <footer class="bg-white p-4 fixed bottom-0 w-full border-t border-gray-100 shadow-[0_-4px_20px_rgba(0,0,0,0.05)] z-20">
        
        <!-- Indicador de escucha (Ondas) -->
        <div id="listeningIndicator" class="absolute -top-10 left-0 w-full flex justify-center sound-wave-container">
            <div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div>
        </div>

        <div class="flex flex-col items-center justify-center relative">
            <!-- Vista previa del texto -->
            <div id="livePreview" class="w-full text-center mb-4 min-h-[1.5rem] px-4">
                <p id="statusText" class="text-sm text-gray-400 transition-colors">Toca el micrófono para empezar</p>
            </div>
            
            <button id="micBtn" class="w-16 h-16 bg-blue-600 hover:bg-blue-700 text-white rounded-full flex items-center justify-center transition-all shadow-lg active:scale-95">
                <i class="fa-solid fa-microphone text-2xl"></i>
            </button>
        </div>
    </footer>

    <!-- Modal de Configuración (API Key) -->
    <div id="settingsModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-6 w-[90%] max-w-md shadow-2xl transform transition-all scale-100">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-lg text-gray-800">Configuración</h3>
                <button id="closeSettings" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-times"></i></button>
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Google Gemini API Key</label>
                <input type="password" id="apiKeyInput" placeholder="Pega tu API Key aquí..." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition">
                <p class="text-xs text-gray-500 mt-2">
                    Necesitas una API Key gratuita de <a href="https://aistudio.google.com/" target="_blank" class="text-blue-600 underline">Google AI Studio</a>.
                </p>
            </div>

            <button id="saveSettings" class="w-full bg-blue-600 text-white py-3 rounded-lg font-medium hover:bg-blue-700 transition">Guardar</button>
        </div>
    </div>

    <script>
        // --- Estado de la Aplicación ---
        const state = {
            apiKey: localStorage.getItem('gemini_api_key') || '',
            isRecording: false,      // ¿Estamos en modo grabación?
            userStopped: false,      // ¿El usuario pulsó detener manualmente?
            transcriptAccumulator: '', // Acumulador para pausas largas
            recognition: null,
            synthesis: window.speechSynthesis,
            messages: []
        };

        // --- Referencias al DOM ---
        const els = {
            micBtn: document.getElementById('micBtn'),
            chatArea: document.getElementById('chatArea'),
            listeningIndicator: document.getElementById('listeningIndicator'),
            statusText: document.getElementById('statusText'),
            settingsBtn: document.getElementById('settingsBtn'),
            settingsModal: document.getElementById('settingsModal'),
            closeSettings: document.getElementById('closeSettings'),
            saveSettings: document.getElementById('saveSettings'),
            apiKeyInput: document.getElementById('apiKeyInput')
        };

        // --- Configuración Inicial ---
        function init() {
            // Configurar Web Speech API (Reconocimiento)
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                state.recognition = new SpeechRecognition();
                state.recognition.lang = 'en-US';
                state.recognition.continuous = true; // CLAVE: No detenerse en silencio
                state.recognition.interimResults = true; // Para mostrar preview
                state.recognition.maxAlternatives = 1;

                state.recognition.onstart = () => {
                    // Solo actualizamos UI si realmente estamos en modo grabación lógica
                    if(state.isRecording) {
                        updateUIState('recording');
                    }
                };

                state.recognition.onend = () => {
                    // Si el usuario NO lo detuvo (ej. corte del navegador), reiniciamos
                    if (state.isRecording && !state.userStopped) {
                        console.log("Reiniciando reconocimiento...");
                        try {
                            state.recognition.start();
                        } catch (e) {
                            console.log("Error al reiniciar inmediato:", e);
                        }
                    } else if (state.userStopped) {
                        // El usuario detuvo y quiere enviar
                        updateUIState('processing');
                        handleFinalSend();
                    } else {
                        updateUIState('idle');
                    }
                };

                state.recognition.onresult = (event) => {
                    let interimTranscript = '';
                    let finalChunk = '';

                    for (let i = event.resultIndex; i < event.results.length; ++i) {
                        if (event.results[i].isFinal) {
                            finalChunk += event.results[i][0].transcript;
                        } else {
                            interimTranscript += event.results[i][0].transcript;
                        }
                    }

                    // Acumulamos lo confirmado
                    state.transcriptAccumulator += finalChunk;
                    
                    // Mostramos preview (Acumulado + Interino)
                    const display = state.transcriptAccumulator + interimTranscript;
                    if (display) {
                        els.statusText.textContent = display;
                        els.statusText.classList.add('text-gray-800', 'font-medium');
                        els.statusText.classList.remove('text-gray-400');
                    }
                };
                
                state.recognition.onerror = (event) => {
                    console.error('Speech recognition error', event.error);
                    if (event.error === 'no-speech') {
                        // Ignorar error de no habla, mantener vivo
                        return;
                    }
                    state.isRecording = false;
                    updateUIState('idle');
                    renderSystemMessage("Error de micrófono: " + event.error);
                };

            } else {
                alert("Tu navegador no soporta reconocimiento de voz. Por favor usa Chrome o Edge.");
                els.micBtn.disabled = true;
            }

            // Pre-llenar API Key si existe
            if (state.apiKey) els.apiKeyInput.value = state.apiKey;
        }

        // --- Lógica de Envío ---
        function handleMicClick() {
            if (!state.isRecording) {
                // START RECORDING
                state.isRecording = true;
                state.userStopped = false;
                state.transcriptAccumulator = ''; // Limpiar buffer anterior
                els.statusText.textContent = "Escuchando..."; 
                
                try {
                    state.recognition.start();
                } catch(e) {
                    console.error("Error start:", e);
                }
                updateUIState('recording');

            } else {
                // STOP AND SEND
                state.userStopped = true; // Bandera para que onend sepa que debe enviar
                state.recognition.stop();
                // La lógica de envío real ocurre en 'onend' para asegurar que tenemos todo el texto
            }
        }

        function handleFinalSend() {
            const textToSend = state.transcriptAccumulator.trim();
            
            if (!textToSend) {
                // Si no dijo nada, volver a idle sin enviar
                updateUIState('idle');
                els.statusText.textContent = "No se detectó voz. Intenta de nuevo.";
                return;
            }

            handleUserMessage(textToSend);
        }

        // --- Manejo de la Interfaz (UI) ---
        function updateUIState(status) {
            if (status === 'recording') {
                els.listeningIndicator.classList.add('active');
                
                // Botón se convierte en Enviar (Avión/Verde)
                els.micBtn.classList.add('mic-button-shadow'); // Sombra verde
                els.micBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                els.micBtn.classList.add('bg-green-500', 'hover:bg-green-600');
                els.micBtn.innerHTML = '<i class="fa-solid fa-paper-plane text-2xl pr-1"></i>'; // Icono enviar
                
                // Texto de estado gestionado por onresult, pero backup aquí
                if(state.transcriptAccumulator === '') {
                     els.statusText.textContent = "Te escucho... (Pulsa para enviar)";
                }

            } else if (status === 'processing') {
                els.listeningIndicator.classList.remove('active');
                els.micBtn.classList.remove('mic-button-shadow');
                
                // Botón gris cargando
                els.micBtn.classList.remove('bg-green-500', 'hover:bg-green-600', 'bg-blue-600');
                els.micBtn.classList.add('bg-gray-400');
                els.micBtn.disabled = true;
                els.micBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin text-2xl"></i>';
                
                els.statusText.textContent = "Thinking...";
                els.statusText.classList.remove('text-gray-800', 'font-medium');
                els.statusText.classList.add('text-blue-600');

            } else { // Idle
                state.isRecording = false;
                els.listeningIndicator.classList.remove('active');
                els.micBtn.classList.remove('mic-button-shadow');
                
                // Volver a micrófono azul
                els.micBtn.classList.remove('bg-green-500', 'bg-gray-400', 'hover:bg-green-600');
                els.micBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                els.micBtn.disabled = false;
                els.micBtn.innerHTML = '<i class="fa-solid fa-microphone text-2xl"></i>';
                
                els.statusText.textContent = "Toca el micrófono para hablar";
                els.statusText.classList.remove('text-blue-600', 'text-gray-800', 'font-medium');
                els.statusText.classList.add('text-gray-400');
            }
        }

        function scrollToBottom() {
            els.chatArea.scrollTop = els.chatArea.scrollHeight;
        }

        // --- Renderizado de Mensajes ---
        function renderUserMessage(text) {
            const html = `
                <div class="flex flex-col items-end mb-6 animate-fade-in">
                    <div class="bg-blue-600 text-white p-4 rounded-2xl rounded-tr-none shadow-md max-w-[85%] text-left">
                        <p>${text}</p>
                    </div>
                    <button onclick="translateText('${escapeHtml(text)}')" class="mt-1 mr-1 text-xs text-gray-400 hover:text-blue-500 flex items-center gap-1 bg-white px-2 py-1 rounded-full border border-gray-100 shadow-sm transition-all">
                        <i class="fa-solid fa-language"></i> Traducir
                    </button>
                </div>
            `;
            els.chatArea.insertAdjacentHTML('beforeend', html);
            scrollToBottom();
        }

        function renderBotResponse(data) {
            let correctionBlock = '';

            if (data.correction && data.correction.hasError) {
                correctionBlock = `
                    <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-green-500 mb-3 w-full">
                        <div class="flex items-center gap-2 mb-2">
                            <i class="fa-solid fa-circle-check text-green-500"></i>
                            <h4 class="text-xs font-bold text-gray-500 uppercase tracking-wide">Corrección Sugerida:</h4>
                        </div>
                        <p class="text-gray-800 text-lg leading-relaxed">
                            ${data.correction.htmlDisplay}
                        </p>
                    </div>
                `;
            }

            const html = `
                <div class="flex gap-3 mb-6 animate-fade-in">
                    <img src="https://randomuser.me/api/portraits/men/32.jpg" class="w-8 h-8 rounded-full self-start mt-1">
                    <div class="flex flex-col max-w-[90%]">
                        
                        ${correctionBlock}

                        <div class="bg-white p-4 rounded-2xl rounded-tl-none shadow-sm border border-gray-100 text-gray-700">
                            <p>${data.response}</p>
                        </div>
                        
                        <button onclick="translateText('${escapeHtml(data.response)}')" class="self-end mt-1 text-xs text-gray-400 hover:text-blue-500 flex items-center gap-1 bg-white px-2 py-1 rounded-full border border-gray-100 shadow-sm transition-all">
                            <i class="fa-solid fa-language"></i> Traducir
                        </button>
                    </div>
                </div>
            `;
            els.chatArea.insertAdjacentHTML('beforeend', html);
            scrollToBottom();
            
            // Hablar la respuesta
            speakText(data.response);
        }

        // --- Lógica Principal (API de Gemini) ---
        async function handleUserMessage(text) {
            renderUserMessage(text);
            // El UI state ya debería estar en processing desde onend, pero reforzamos por si acaso
            updateUIState('processing');

            if (!state.apiKey) {
                renderSystemMessage("⚠️ Por favor configura tu API Key en el icono de engranaje.");
                updateUIState('idle');
                return;
            }

            try {
                const response = await fetchGeminiResponse(text);
                renderBotResponse(response);
            } catch (error) {
                console.error(error);
                renderSystemMessage(`Error: ${error.message}. Verifica API Key y cuota.`);
            } finally {
                updateUIState('idle');
            }
        }

        async function fetchGeminiResponse(userText) {
            // CAMBIO: Usamos 'gemini-1.5-flash' que es más estable y universalmente disponible
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${state.apiKey}`;
            
            const systemPrompt = `
                You are Prof. Alex, a friendly and professional English tutor. 
                Your goal is to converse with the user and CORRECT their grammar/vocabulary mistakes.
                
                INSTRUCTIONS:
                1. Analyze the user's input for English errors.
                2. If errors exist, construct a 'correction' object.
                3. For the visual correction style: 
                   - Wrap incorrect words in <span class="text-red-500 line-through decoration-2">...</span>
                   - Wrap correct words in <span class="text-green-500 font-bold bg-green-50 px-1 rounded">...</span>
                   - Reconstruct the sentence showing the errors crossed out and corrections next to them.
                4. Always provide a natural, conversational 'response' to keep the chat going.
                5. Respond ONLY in valid JSON format.

                JSON SCHEMA:
                {
                    "correction": {
                        "hasError": boolean,
                        "htmlDisplay": "String with HTML spans for red/green styling" 
                    },
                    "response": "String (Conversational reply)"
                }

                Example of htmlDisplay: "My favorite <span class=\"text-red-500 line-through decoration-2\">gender</span> <span class=\"text-green-500 font-bold bg-green-50 px-1 rounded\">genre</span> of music is rock."
            `;

            const payload = {
                contents: [{
                    parts: [{ text: userText }]
                }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
                generationConfig: {
                    responseMimeType: "application/json"
                }
            };

            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const data = await response.json();
            
            if (data.error) throw new Error(data.error.message);
            
            // LIMPIEZA DE RESPUESTA: A veces Gemini añade bloques markdown
            let rawText = data.candidates[0].content.parts[0].text;
            rawText = rawText.replace(/```json/g, '').replace(/```/g, '').trim();

            try {
                return JSON.parse(rawText);
            } catch (e) {
                console.error("Error parseando JSON:", rawText);
                throw new Error("La IA respondió con un formato inválido. Intenta de nuevo.");
            }
        }

        // --- Text to Speech (TTS) ---
        function speakText(text) {
            if (!state.synthesis) return;
            
            state.synthesis.cancel();

            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'en-US';
            utterance.rate = 1;
            utterance.pitch = 1;

            const voices = state.synthesis.getVoices();
            // Buscar voz preferida: Microsoft David/Mark/Zira o Google US English
            const preferredVoice = voices.find(v => 
                (v.name.includes('Google US English') || v.name.includes('Microsoft David')) && v.lang.startsWith('en')
            );
            
            if (preferredVoice) utterance.voice = preferredVoice;

            state.synthesis.speak(utterance);
        }

        // --- Utilidades ---
        function renderSystemMessage(msg) {
            const html = `<div class="text-center text-xs text-red-400 my-4">${msg}</div>`;
            els.chatArea.insertAdjacentHTML('beforeend', html);
            scrollToBottom();
        }

        function escapeHtml(text) {
            return text.replace(/'/g, "\\'");
        }
        
        window.translateText = (text) => {
            const url = `https://translate.google.com/?sl=en&tl=es&text=${encodeURIComponent(text)}&op=translate`;
            window.open(url, '_blank');
        };

        // --- Event Listeners ---
        els.micBtn.addEventListener('click', handleMicClick);

        els.settingsBtn.addEventListener('click', () => {
            els.settingsModal.classList.remove('hidden');
            els.settingsModal.classList.add('flex');
        });

        els.closeSettings.addEventListener('click', () => {
            els.settingsModal.classList.add('hidden');
            els.settingsModal.classList.remove('flex');
        });

        els.saveSettings.addEventListener('click', () => {
            const key = els.apiKeyInput.value.trim();
            if (key) {
                localStorage.setItem('gemini_api_key', key);
                state.apiKey = key;
                els.settingsModal.classList.add('hidden');
                els.settingsModal.classList.remove('flex');
                alert("¡API Key guardada correctamente!");
            }
        });

        init();
        window.speechSynthesis.onvoiceschanged = () => {};

    </script>
</body>
</html>
