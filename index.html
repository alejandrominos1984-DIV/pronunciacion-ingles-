<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Prof. Sterling - AI English Tutor</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- FontAwesome & Lucide Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Marked for Markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f9fa;
            height: 100vh;
            overflow: hidden; /* Prevent body scroll, handle in chat container */
        }

        /* Custom Scrollbar */
        .chat-container::-webkit-scrollbar {
            width: 6px;
        }
        .chat-container::-webkit-scrollbar-track {
            background: transparent;
        }
        .chat-container::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 20px;
        }

        /* Message Bubbles */
        .bubble-user {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            color: white;
            border-radius: 18px 18px 4px 18px;
            box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.2);
        }

        .bubble-ai {
            background-color: #ffffff;
            color: #1e293b;
            border-radius: 18px 18px 18px 4px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        /* Correction Box Styling */
        .correction-box {
            background-color: #f0fdf4; /* Green-50 tint */
            border: 1px solid #dcfce7;
            border-left: 4px solid #22c55e;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
            font-size: 0.95rem;
            position: relative;
        }

        .correction-diff del {
            color: #ef4444; /* Red */
            text-decoration: line-through;
            font-weight: 600;
            margin-right: 4px;
            background-color: #fecaca;
            padding: 0 4px;
            border-radius: 4px;
        }

        .correction-diff ins {
            color: #16a34a; /* Green */
            text-decoration: none;
            font-weight: 600;
            background-color: #bbf7d0;
            padding: 0 4px;
            border-radius: 4px;
        }

        /* Audio Visualizer Animation */
        .visualizer {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 3px;
            height: 20px;
        }
        
        .bar {
            width: 3px;
            background-color: #ffffff;
            border-radius: 999px;
            animation: sound 0ms -800ms linear infinite alternate;
            height: 4px;
        }

        .visualizer.active .bar {
            animation-duration: 400ms;
        }

        @keyframes sound {
            0% { height: 4px; opacity: 0.5; }
            100% { height: 24px; opacity: 1; }
        }

        /* Mic Button Pulse */
        .mic-active {
            animation: pulse-ring 1.5s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
        }

        @keyframes pulse-ring {
            0% { box-shadow: 0 0 0 0 rgba(37, 99, 235, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(37, 99, 235, 0); }
            100% { box-shadow: 0 0 0 0 rgba(37, 99, 235, 0); }
        }

        .typing-dot {
            animation: typing 1.4s infinite ease-in-out both;
        }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
    </style>
</head>
<body class="flex flex-col relative">

    <!-- Config Modal (API Key) -->
    <div id="configModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white rounded-2xl p-6 w-11/12 max-w-md shadow-2xl transform transition-all scale-100">
            <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                <i class="fas fa-cog text-gray-500"></i> Configuración
            </h2>
            <p class="text-sm text-gray-600 mb-4">
                Para hablar con Prof. Sterling, necesitas una API Key de Google Gemini. 
                <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-blue-600 hover:underline">Obtén una gratis aquí</a>.
            </p>
            <div class="mb-4">
                <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">Gemini API Key</label>
                <input type="password" id="apiKeyInput" placeholder="Paste your API Key here..." 
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none transition-colors">
            </div>
            <div class="flex justify-end gap-3">
                <button onclick="closeConfig()" class="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded-lg transition">Cancelar</button>
                <button onclick="saveConfig()" class="px-6 py-2 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 shadow-md transition">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="bg-white border-b border-gray-200 px-4 py-3 flex items-center justify-between sticky top-0 z-10 shadow-sm">
        <div class="flex items-center gap-3">
            <div class="relative">
                <img src="https://img.freepik.com/free-photo/handsome-young-man-with-new-stylish-haircut_176420-19637.jpg" 
                     alt="Prof. Sterling" 
                     class="w-10 h-10 rounded-full object-cover border-2 border-green-400">
                <div class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 border-2 border-white rounded-full"></div>
            </div>
            <div>
                <h1 class="text-base font-bold text-gray-900 leading-tight">Prof. Sterling</h1>
                <p class="text-xs text-blue-600 font-medium">AI English Tutor</p>
            </div>
        </div>
        <button onclick="openConfig()" class="text-gray-400 hover:text-gray-600 transition p-2 rounded-full hover:bg-gray-100">
            <i class="fas fa-cog text-lg"></i>
        </button>
    </header>

    <!-- Chat Area -->
    <main id="chatContainer" class="flex-1 overflow-y-auto p-4 space-y-6 chat-container bg-slate-50 pb-32">
        
        <!-- Welcome Message -->
        <div class="flex gap-3">
            <img src="https://img.freepik.com/free-photo/handsome-young-man-with-new-stylish-haircut_176420-19637.jpg" 
                 class="w-8 h-8 rounded-full object-cover mt-1 self-start shadow-sm">
            <div class="flex flex-col gap-1 max-w-[85%]">
                <div class="bubble-ai px-4 py-3 text-sm leading-relaxed">
                    <p>Hello! I'm Prof. Sterling. I'm here to help you practice English. I will listen to you and correct any mistakes I hear. What would you like to talk about today?</p>
                </div>
                <!-- Translation Icon -->
                <div class="self-end flex items-center gap-1 cursor-pointer opacity-80 hover:opacity-100 transition" onclick="translateText(this)">
                    <img src="https://cdn-icons-png.flaticon.com/512/3898/3898150.png" alt="Translate" class="w-4 h-4">
                    <span class="text-[10px] font-bold text-gray-500 uppercase tracking-wide">Traducir</span>
                </div>
            </div>
        </div>

    </main>

    <!-- Controls Area -->
    <footer class="bg-white border-t border-gray-200 p-4 sticky bottom-0 z-20 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
        
        <!-- Live Transcript Preview (visible when recording) -->
        <div id="liveTranscript" class="text-center text-sm text-gray-500 mb-3 h-6 overflow-hidden transition-all opacity-0">
            ...
        </div>

        <div class="flex items-center justify-center gap-4 relative">
            
            <!-- Main Action Button -->
            <button id="actionBtn" class="w-16 h-16 rounded-full bg-blue-600 text-white shadow-lg shadow-blue-600/30 flex items-center justify-center transition-all transform hover:scale-105 active:scale-95 z-20 relative">
                <i id="actionIcon" class="fas fa-microphone text-2xl"></i>
                <div id="visualizer" class="visualizer absolute hidden">
                    <div class="bar" style="animation-delay: -0.4s"></div>
                    <div class="bar" style="animation-delay: -0.2s"></div>
                    <div class="bar" style="animation-delay: 0s"></div>
                    <div class="bar" style="animation-delay: -0.3s"></div>
                </div>
            </button>

            <!-- Text overlay instruction -->
            <div id="statusText" class="absolute -top-10 bg-gray-800 text-white text-xs px-3 py-1 rounded-full opacity-0 transition-opacity">
                Presiona para enviar
            </div>

        </div>
        <p class="text-center text-xs text-gray-400 mt-3 font-medium">
            <span id="modeText">Toca para hablar</span>
        </p>
    </footer>

    <!-- Audio Element for playback -->
    <audio id="audioPlayer" class="hidden"></audio>

    <script>
        // --- Configuration & State ---
        let apiKey = localStorage.getItem('gemini_api_key') || '';
        let conversationHistory = [];
        let isRecording = false;
        let finalTranscript = '';
        let recognition;
        
        // DOM Elements
        const actionBtn = document.getElementById('actionBtn');
        const actionIcon = document.getElementById('actionIcon');
        const visualizer = document.getElementById('visualizer');
        const liveTranscript = document.getElementById('liveTranscript');
        const chatContainer = document.getElementById('chatContainer');
        const configModal = document.getElementById('configModal');
        const modeText = document.getElementById('modeText');
        const statusText = document.getElementById('statusText');
        const audioPlayer = document.getElementById('audioPlayer');

        // Check for API Key on load
        if (!apiKey) {
            setTimeout(() => openConfig(), 500);
        }

        // --- Speech Recognition Setup ---
        if ('webkitSpeechRecognition' in window) {
            recognition = new webkitSpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = 'en-US'; // English Tutor

            recognition.onstart = () => {
                isRecording = true;
                updateUIState('recording');
            };

            // FIX: Rebuild transcript from scratch on every event to avoid Android duplication bugs
            recognition.onresult = (event) => {
                let fullTranscript = '';
                
                // Instead of appending to a global variable using event.resultIndex (which is buggy on Android),
                // we iterate over the entire results array provided by the API each time.
                for (let i = 0; i < event.results.length; ++i) {
                    let transcriptSegment = event.results[i][0].transcript;
                    
                    // Simple spacing logic: if segment doesn't start with space and previous didn't end with one, add it
                    // (Though usually browsers handle this, explicit check is safer)
                    /* Note: We just concatenate here because re-inserting spaces can be tricky if the engine 
                       already provides them. Most modern engines (Chrome/Android) provide the segments 
                       correctly spaced or not.
                    */
                    fullTranscript += transcriptSegment;
                }
                
                finalTranscript = fullTranscript;
                liveTranscript.textContent = finalTranscript;
                liveTranscript.classList.remove('opacity-0');
            };

            recognition.onerror = (event) => {
                console.error('Speech recognition error', event.error);
                if(event.error === 'not-allowed') {
                    alert('Por favor permite el acceso al micrófono.');
                    resetUI();
                }
            };

            recognition.onend = () => {
                // If we stopped manually to send, isRecording will be false handled by logic.
                // If it stopped by itself but we are still in "recording mode" logic, restart it?
                // The prompt says "doesn't cut if you pause". Continuous handles most, but if silence is too long chrome stops.
                if (isRecording) {
                   try { recognition.start(); } catch(e){}
                }
            };
        } else {
            alert("Tu navegador no soporta Web Speech API. Por favor usa Google Chrome o Edge.");
        }

        // --- UI Interactions ---

        actionBtn.addEventListener('click', () => {
            if (!apiKey) {
                openConfig();
                return;
            }

            if (!isRecording) {
                // Start Recording
                finalTranscript = '';
                liveTranscript.textContent = '';
                try {
                    recognition.start();
                } catch (e) {
                    console.warn("Recognition already started");
                }
            } else {
                // Stop & Send
                isRecording = false; // Flag to prevent auto-restart in onend
                recognition.stop();
                updateUIState('idle');
                
                // Use the rebuilt transcript
                let messageToSend = finalTranscript.trim();
                
                // Fallback: sometimes liveTranscript has text but finalTranscript var might be lagging in edge cases?
                // Should be fine with new logic, but let's be safe.
                if (!messageToSend) {
                    messageToSend = liveTranscript.textContent.trim();
                }

                if (messageToSend.length > 0) {
                    handleUserMessage(messageToSend);
                }
            }
        });

        function updateUIState(state) {
            if (state === 'recording') {
                actionBtn.classList.add('mic-active');
                actionBtn.classList.remove('bg-blue-600');
                actionBtn.classList.add('bg-red-500');
                actionIcon.classList.remove('fa-microphone');
                actionIcon.classList.add('hidden'); // Hide mic icon, show visualizer or paper plane?
                // Actually user requested: "Changes icon to Send"
                actionIcon.classList.remove('hidden');
                actionIcon.classList.remove('fa-microphone');
                actionIcon.classList.add('fa-paper-plane');
                
                visualizer.classList.remove('hidden');
                visualizer.classList.add('active');
                
                modeText.innerText = "Toca para enviar";
                liveTranscript.classList.remove('opacity-0');
            } else {
                actionBtn.classList.remove('mic-active');
                actionBtn.classList.add('bg-blue-600');
                actionBtn.classList.remove('bg-red-500');
                
                actionIcon.classList.remove('hidden');
                actionIcon.classList.add('fa-microphone');
                actionIcon.classList.remove('fa-paper-plane');
                
                visualizer.classList.add('hidden');
                visualizer.classList.remove('active');
                
                modeText.innerText = "Toca para hablar";
                liveTranscript.classList.add('opacity-0');
            }
        }

        function resetUI() {
            isRecording = false;
            updateUIState('idle');
        }

        // --- Core Logic: Gemini API ---

        async function handleUserMessage(message) {
            // 1. Add User Bubble
            appendMessage('user', message);

            // 2. Show Loading
            const loadingId = appendLoading();

            try {
                // 3. Prepare Prompt
                // We ask for a JSON structure to separate Correction from Response
                const systemPrompt = `
                You are Prof. Sterling, a friendly and encouraging private English tutor (Male). 
                Your student is chatting with you via voice.
                
                TASK:
                1. Analyze the user's input for grammatical, spelling, or unnatural errors.
                2. Formulate a natural, conversational response to keep the chat going.
                
                OUTPUT FORMAT:
                You must return a strictly valid JSON object. Do not include markdown formatting like \`\`\`json.
                Structure:
                {
                    "hasError": boolean,
                    "correctionHtml": "string or null", 
                    "conversationalResponse": "string"
                }

                For "correctionHtml":
                - If there is an error, recreate the sentence.
                - Wrap incorrect words in <del>WRONG</del>.
                - Wrap correct words in <ins>RIGHT</ins>.
                - Example: "My favorite <del>gender</del> <ins>genre</ins> of music..."
                - If no error, this field is null.

                Keep the conversational response concise (1-3 sentences) so the audio isn't too long.
                `;

                // 4. API Call (Text Generation)
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [
                            { role: 'user', parts: [{ text: systemPrompt }] }, // System instruction disguised as first user msg for simple context or use system_instruction if supported
                            ...conversationHistory, // Previous context
                            { role: 'user', parts: [{ text: `User said: "${message}"` }] }
                        ],
                        generationConfig: {
                            responseMimeType: "application/json"
                        }
                    })
                });

                const data = await response.json();
                
                if (!data.candidates || !data.candidates[0].content) {
                    throw new Error("Invalid API response");
                }

                const aiText = data.candidates[0].content.parts[0].text;
                const parsedAI = JSON.parse(aiText);

                // Remove Loading
                document.getElementById(loadingId).remove();

                // 5. Render AI Response
                appendMessage('ai', parsedAI.conversationalResponse, parsedAI.correctionHtml);

                // Update History
                conversationHistory.push({ role: 'user', parts: [{ text: message }] });
                conversationHistory.push({ role: 'model', parts: [{ text: aiText }] }); // Store raw JSON in history so model remembers it corrected user

                // 6. Generate Audio (Gemini TTS)
                playGeminiTTS(parsedAI.conversationalResponse);

            } catch (error) {
                console.error(error);
                document.getElementById(loadingId).remove();
                appendMessage('ai', "I'm having trouble connecting to the class. Please check your API Key settings.");
            }
        }

        async function playGeminiTTS(text) {
            try {
                // Using the specialized Gemini TTS endpoint
                // Note: Ensure the API key has access to gemini-2.5-flash-preview-tts or similar
                const ttsResponse = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: text }] }],
                        generationConfig: {
                            speechConfig: {
                                voiceConfig: {
                                    prebuiltVoiceConfig: {
                                        voiceName: "Fenrir" // Male voice
                                    }
                                }
                            }
                        }
                    })
                });

                const ttsData = await ttsResponse.json();
                
                if (ttsData.candidates && ttsData.candidates[0].content.parts[0].inlineData) {
                    const audioContent = ttsData.candidates[0].content.parts[0].inlineData.data;
                    const audioBlob = b64toBlob(audioContent, "audio/mp3");
                    const audioUrl = URL.createObjectURL(audioBlob);
                    audioPlayer.src = audioUrl;
                    audioPlayer.play();
                } else {
                    // Fallback to browser TTS if Gemini TTS fails/not available
                    speakBrowser(text);
                }
            } catch (e) {
                console.warn("Gemini TTS failed, falling back to browser", e);
                speakBrowser(text);
            }
        }

        function speakBrowser(text) {
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'en-US';
            // Try to find a male voice
            const voices = window.speechSynthesis.getVoices();
            const maleVoice = voices.find(v => v.name.includes('Male') || v.name.includes('David') || v.name.includes('Google US English'));
            if (maleVoice) utterance.voice = maleVoice;
            window.speechSynthesis.speak(utterance);
        }

        // Helper: Base64 to Blob
        function b64toBlob(b64Data, contentType='', sliceSize=512) {
            const byteCharacters = atob(b64Data);
            const byteArrays = [];
            for (let offset = 0; offset < byteCharacters.length; offset += sliceSize) {
                const slice = byteCharacters.slice(offset, offset + sliceSize);
                const byteNumbers = new Array(slice.length);
                for (let i = 0; i < slice.length; i++) {
                    byteNumbers[i] = slice.charCodeAt(i);
                }
                const byteArray = new Uint8Array(byteNumbers);
                byteArrays.push(byteArray);
            }
            return new Blob(byteArrays, {type: contentType});
        }

        // --- DOM Manipulation Helpers ---

        function appendMessage(role, text, correctionHtml = null) {
            const div = document.createElement('div');
            div.className = 'flex gap-3 animate-fade-in-up';
            div.style.animation = 'fadeIn 0.3s ease-out';

            let contentHtml = '';

            if (role === 'user') {
                div.classList.add('justify-end');
                contentHtml = `
                    <div class="bubble-user px-5 py-3 max-w-[85%] text-base shadow-md">
                        ${text}
                    </div>
                `;
            } else {
                // AI Logic
                div.classList.add('justify-start');
                
                let correctionBlock = '';
                if (correctionHtml) {
                    correctionBlock = `
                        <div class="correction-box shadow-sm">
                            <div class="flex items-center gap-2 mb-2 text-green-700 font-bold text-xs uppercase tracking-wider">
                                <i class="fas fa-check-circle"></i> Corrección Sugerida
                            </div>
                            <div class="correction-diff text-gray-700">
                                ${correctionHtml}
                            </div>
                        </div>
                    `;
                }

                contentHtml = `
                    <img src="https://img.freepik.com/free-photo/handsome-young-man-with-new-stylish-haircut_176420-19637.jpg" 
                         class="w-8 h-8 rounded-full object-cover mt-1 self-start shadow-sm border border-gray-200">
                    <div class="flex flex-col gap-1 max-w-[85%]">
                        <div class="bubble-ai px-4 py-3 text-base leading-relaxed">
                            ${correctionBlock}
                            <div class="ai-text">${marked.parse(text)}</div>
                        </div>
                        <div class="self-end flex items-center gap-1 cursor-pointer opacity-80 hover:opacity-100 transition group" onclick="translateText(this)">
                            <div class="bg-white p-1 rounded shadow-sm border border-gray-100 group-hover:scale-105 transition-transform">
                                <img src="https://cdn-icons-png.flaticon.com/512/3898/3898150.png" alt="Translate" class="w-4 h-4">
                            </div>
                            <span class="text-[10px] font-bold text-gray-500 uppercase tracking-wide group-hover:text-blue-500">Traducir</span>
                        </div>
                    </div>
                `;
            }

            div.innerHTML = contentHtml;
            chatContainer.appendChild(div);
            scrollToBottom();
        }

        function appendLoading() {
            const id = 'loading-' + Date.now();
            const div = document.createElement('div');
            div.id = id;
            div.className = 'flex gap-3 justify-start';
            div.innerHTML = `
                <img src="https://img.freepik.com/free-photo/handsome-young-man-with-new-stylish-haircut_176420-19637.jpg" 
                     class="w-8 h-8 rounded-full object-cover mt-1 self-start opacity-70">
                <div class="bubble-ai px-4 py-4 rounded-xl flex items-center gap-1">
                    <div class="w-2 h-2 bg-gray-400 rounded-full typing-dot"></div>
                    <div class="w-2 h-2 bg-gray-400 rounded-full typing-dot"></div>
                    <div class="w-2 h-2 bg-gray-400 rounded-full typing-dot"></div>
                </div>
            `;
            chatContainer.appendChild(div);
            scrollToBottom();
            return id;
        }

        function scrollToBottom() {
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        async function translateText(btnElement) {
            // Find the associated text bubble
            const container = btnElement.parentElement;
            const textElement = container.querySelector('.ai-text');
            const originalText = textElement.textContent;

            // Visual feedback
            const originalIcon = btnElement.innerHTML;
            btnElement.innerHTML = '<i class="fas fa-spinner fa-spin text-blue-500"></i>';

            try {
                // Simple translate call (using same model)
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: `Translate the following English text to Spanish. Only output the translation, nothing else.\n\nText: "${originalText}"` }] }]
                    })
                });
                
                const data = await response.json();
                const translation = data.candidates[0].content.parts[0].text;
                
                // Replace text briefly or alert? User requested UI translate icon functionality. 
                // Let's create a temporary overlay or replace text.
                // Approach: Append translation below original text in italics
                
                if (!textElement.querySelector('.translation-result')) {
                    const transDiv = document.createElement('div');
                    transDiv.className = 'translation-result mt-2 pt-2 border-t border-gray-200 text-gray-600 italic text-sm';
                    transDiv.innerText = translation;
                    textElement.appendChild(transDiv);
                }

            } catch (e) {
                alert("Error al traducir. Verifica tu API Key.");
            } finally {
                btnElement.innerHTML = originalIcon;
            }
        }

        // --- Config Modal Logic ---
        function openConfig() {
            document.getElementById('apiKeyInput').value = apiKey;
            configModal.classList.remove('hidden');
        }

        function closeConfig() {
            configModal.classList.add('hidden');
        }

        function saveConfig() {
            const val = document.getElementById('apiKeyInput').value.trim();
            if (val) {
                apiKey = val;
                localStorage.setItem('gemini_api_key', apiKey);
                closeConfig();
                // Reload page to apply clean state or just continue? Continue is fine.
                alert("¡Configuración guardada! Prof. Sterling está listo.");
            } else {
                alert("Por favor ingresa una API Key válida.");
            }
        }
        
        // CSS Animation Keyframes injection
        const styleSheet = document.createElement("style");
        styleSheet.innerText = `
            @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        `;
        document.head.appendChild(styleSheet);

    </script>
</body>
</html>
