<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#2563eb">
    <title>English AI Tutor</title>
    
    <!-- Tailwind CSS (CDN for Speed/Simplicity) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background-color: #f0f2f5;
            overscroll-behavior: none; /* Prevent pull-to-refresh on mobile */
        }
        .chat-container {
            -webkit-overflow-scrolling: touch;
        }
        .chat-bubble {
            max-width: 85%;
            padding: 14px 18px;
            border-radius: 1.2rem;
            margin-bottom: 12px;
            position: relative;
            line-height: 1.5;
            font-size: 0.95rem;
            animation: fadeIn 0.3s ease-out;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .user-msg {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 0.2rem;
        }
        .bot-msg {
            background-color: white;
            color: #1f2937;
            align-self: flex-start;
            border-bottom-left-radius: 0.2rem;
        }
        .correction {
            background-color: #fffbeb;
            color: #92400e;
            font-size: 0.9em;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 8px;
            border-left: 4px solid #f59e0b;
        }
        .pulse-ring {
            box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            animation: pulse-ring 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse-ring {
            70% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    </style>
</head>
<body class="h-[100dvh] flex flex-col items-center justify-center p-0 md:p-4 fixed w-full top-0 left-0">

    <!-- Settings Modal -->
    <div id="configPanel" class="hidden absolute z-50 inset-0 bg-black/50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-sm rounded-2xl shadow-2xl p-6 transform transition-all scale-100">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-bold text-gray-800">‚öôÔ∏è Configuraci√≥n</h2>
                <button onclick="toggleConfig()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-600 uppercase mb-1">Gemini API Key</label>
                    <input type="password" id="apiKeyInput" placeholder="Pega tu clave aqu√≠..." class="w-full p-3 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none bg-gray-50">
                    <p class="text-xs text-gray-400 mt-1">Se guarda solo en tu navegador.</p>
                </div>
                
                <div>
                    <label class="block text-xs font-bold text-gray-600 uppercase mb-1">Voz del Tutor</label>
                    <select id="voiceSelect" class="w-full p-3 border rounded-lg text-sm bg-gray-50">
                        <option value="">Cargando voces...</option>
                    </select>
                </div>

                <button onclick="saveAndCloseConfig()" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700 transition">
                    Guardar y Cerrar
                </button>
                
                <div class="mt-4 pt-4 border-t text-center">
                    <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-xs text-blue-500 hover:underline">
                        Obtener API Key gratis de Google
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App Interface -->
    <div class="w-full h-full md:h-[650px] md:max-w-md bg-white md:rounded-3xl shadow-2xl overflow-hidden flex flex-col relative">
        
        <!-- Header -->
        <div class="bg-blue-600 p-4 pt-safe-top flex items-center justify-between shrink-0 shadow-md z-10">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-white/20 backdrop-blur-md rounded-full flex items-center justify-center text-white font-bold text-lg border border-white/30">
                    <i class="fas fa-robot"></i>
                </div>
                <div>
                    <h1 class="font-bold text-lg text-white leading-tight">AI English Tutor</h1>
                    <div class="flex items-center gap-1.5">
                        <span class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></span>
                        <span class="text-xs text-blue-100 font-medium">Online</span>
                    </div>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="resetChat()" class="w-8 h-8 rounded-full bg-white/10 text-white flex items-center justify-center hover:bg-white/20 transition">
                    <i class="fas fa-redo-alt text-sm"></i>
                </button>
                <button onclick="toggleConfig()" class="w-8 h-8 rounded-full bg-white/10 text-white flex items-center justify-center hover:bg-white/20 transition">
                    <i class="fas fa-cog text-sm"></i>
                </button>
            </div>
        </div>

        <!-- Chat Area -->
        <div id="chatContainer" class="flex-1 overflow-y-auto p-4 flex flex-col gap-2 bg-slate-50 chat-container pb-24">
            <!-- Initial Message -->
            <div class="bot-msg chat-bubble">
                Hello! I'm your English tutor. üëã <br>
                I'll help you practice conversation and correct your mistakes. Click the microphone to start talking!
            </div>
        </div>

        <!-- Floating Controls (Better for Mobile) -->
        <div class="absolute bottom-0 left-0 w-full p-5 bg-gradient-to-t from-white via-white to-transparent pb-safe-bottom">
            <div class="flex flex-col items-center gap-3">
                
                <div id="statusText" class="text-sm text-gray-500 font-medium h-5 transition-all">Ready to listen...</div>

                <button id="micBtn" class="w-20 h-20 rounded-full bg-blue-600 text-white text-3xl shadow-xl hover:bg-blue-700 active:scale-95 transition-all flex items-center justify-center focus:outline-none z-20">
                    <i class="fas fa-microphone"></i>
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- State & Config ---
        let GEMINI_API_KEY = localStorage.getItem('gemini_api_key') || "";
        
        const chatContainer = document.getElementById('chatContainer');
        const statusText = document.getElementById('statusText');
        const micBtn = document.getElementById('micBtn');
        const voiceSelect = document.getElementById('voiceSelect');
        const apiKeyInput = document.getElementById('apiKeyInput');
        const configPanel = document.getElementById('configPanel');

        let isListening = false;
        let recognition;
        let synthesis = window.speechSynthesis;
        let conversationHistory = [];
        
        const SYSTEM_PROMPT = `You are a friendly, patient English teacher. 
        1. Keep the conversation natural and engaging.
        2. CRITICAL: If the user makes a grammar, vocabulary, or pronunciation mistake, START your response with a distinct "Correction:" block explained briefly.
        3. If there are no mistakes, simply reply to the conversation.
        4. Keep your conversational replies concise (1-3 sentences).`;

        // --- Initialization ---
        function init() {
            // Setup Speech Recognition
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.lang = 'en-US'; 
                recognition.continuous = false; // Mobile prefers false
                recognition.interimResults = false;

                recognition.onstart = () => {
                    isListening = true;
                    updateMicUI(true);
                    statusText.textContent = "Listening...";
                };

                recognition.onend = () => {
                    isListening = false;
                    updateMicUI(false);
                };

                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    if (transcript) handleUserInput(transcript);
                };

                recognition.onerror = (event) => {
                    console.error("Speech error", event.error);
                    statusText.textContent = "Error: " + event.error;
                    isListening = false;
                    updateMicUI(false);
                };
            } else {
                alert("Speech Recognition not supported in this browser. Please use Chrome, Edge, or Safari.");
                micBtn.disabled = true;
                micBtn.classList.add('opacity-50');
            }

            // Load Voices
            populateVoices();
            if (speechSynthesis.onvoiceschanged !== undefined) {
                speechSynthesis.onvoiceschanged = populateVoices;
            }

            // Init History
            conversationHistory = [{ role: "user", parts: [{ text: SYSTEM_PROMPT }] }];

            // Check Key
            if (!GEMINI_API_KEY) {
                setTimeout(() => toggleConfig(), 1000); // Ask for key if missing
            } else {
                apiKeyInput.value = GEMINI_API_KEY;
            }
        }

        // --- UI Functions ---
        function toggleConfig() {
            configPanel.classList.toggle('hidden');
        }

        function saveAndCloseConfig() {
            const key = apiKeyInput.value.trim();
            if (key) {
                GEMINI_API_KEY = key;
                localStorage.setItem('gemini_api_key', key);
                toggleConfig();
                alert("Key saved securely in your browser!");
            } else {
                alert("Please enter a valid API Key.");
            }
        }

        function populateVoices() {
            const voices = synthesis.getVoices().filter(v => v.lang.includes('en'));
            voiceSelect.innerHTML = '';
            voices.forEach((voice) => {
                const option = document.createElement('option');
                option.textContent = `${voice.name.slice(0, 30)}...`;
                option.value = voice.name;
                // Prefer Google or high quality voices
                if (voice.name.includes('Google') || voice.name.includes('Premium')) {
                    option.selected = true;
                }
                voiceSelect.appendChild(option);
            });
        }

        function updateMicUI(listening) {
            if (listening) {
                micBtn.classList.remove('bg-blue-600');
                micBtn.classList.add('bg-red-500', 'pulse-ring');
                micBtn.innerHTML = '<i class="fas fa-stop"></i>';
            } else {
                micBtn.classList.add('bg-blue-600');
                micBtn.classList.remove('bg-red-500', 'pulse-ring');
                micBtn.innerHTML = '<i class="fas fa-microphone"></i>';
            }
        }

        function addMessage(text, isUser, isCorrection = false) {
            const div = document.createElement('div');
            div.classList.add('chat-bubble');
            
            if (isCorrection) {
                div.classList.add('correction');
                // Format correction bolding
                div.innerHTML = text.replace(/(Correction:|Mistake:)/gi, '<strong>$1</strong>');
            } else {
                div.classList.add(isUser ? 'user-msg' : 'bot-msg');
                div.textContent = text;
            }
            
            chatContainer.appendChild(div);
            // Smooth scroll
            chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' });
        }

        micBtn.addEventListener('click', () => {
            if (!GEMINI_API_KEY) {
                toggleConfig();
                return;
            }
            if (isListening) recognition.stop();
            else recognition.start();
        });

        // --- Core Logic ---
        async function handleUserInput(text) {
            addMessage(text, true);
            statusText.textContent = "Thinking...";
            
            conversationHistory.push({ role: "user", parts: [{ text: text }] });

            try {
                const responseText = await callGeminiAPI();
                processGeminiResponse(responseText);
            } catch (error) {
                console.error(error);
                statusText.textContent = "Connection Error";
                addMessage("Error connecting to Gemini. Check your API Key.", false);
            }
        }

        async function callGeminiAPI() {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_API_KEY}`;
            const payload = {
                contents: conversationHistory,
                generationConfig: { maxOutputTokens: 300, temperature: 0.7 }
            };

            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) throw new Error('API Error');
            const data = await response.json();
            return data.candidates[0].content.parts[0].text;
        }

        function processGeminiResponse(text) {
            conversationHistory.push({ role: "model", parts: [{ text: text }] });
            statusText.textContent = "Click mic to reply";

            // Detect correction block
            const parts = text.split(/\n/);
            let speechText = text;

            // Simple heuristic display
            // If the AI formatted it well with "Correction:", highlight it
            if (text.toLowerCase().includes('correction:')) {
                const correctionPart = parts.find(p => p.toLowerCase().includes('correction:'));
                const conversationPart = parts.filter(p => !p.toLowerCase().includes('correction:')).join(' ');
                
                if (correctionPart) addMessage(correctionPart, false, true);
                if (conversationPart.trim()) addMessage(conversationPart, false);
                speechText = conversationPart; // Only speak the conversation part usually, or both.
            } else {
                addMessage(text, false);
            }

            speakText(text); // Speak everything for full learning
        }

        function speakText(text) {
            if (synthesis.speaking) synthesis.cancel();
            
            // Cleanup text for TTS (remove markdown chars)
            const cleanText = text.replace(/[*_#]/g, ''); 
            
            const utterance = new SpeechSynthesisUtterance(cleanText);
            const voices = synthesis.getVoices();
            const selectedName = voiceSelect.value;
            const selectedVoice = voices.find(v => v.name === selectedName);
            
            if (selectedVoice) utterance.voice = selectedVoice;
            utterance.rate = 0.9;
            
            synthesis.speak(utterance);
        }

        function resetChat() {
            if(confirm("Start new conversation?")) {
                location.reload();
            }
        }

        init();
    </script>
</body>
</html>
