<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prof. Sterling | AI English Tutor</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap">
    <style>
        :root {
            --primary: #4361ee;
            --primary-dark: #3a56d4;
            --secondary: #7209b7;
            --accent: #f72585;
            --success: #4cc9f0;
            --error: #ff006e;
            --warning: #ff9e00;
            --dark: #212529;
            --light: #f8f9fa;
            --gray: #6c757d;
            --light-gray: #e9ecef;
            --user-bubble: #4361ee;
            --bot-bubble: #f1f3f9;
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.08);
            --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.12);
            --shadow-lg: 0 8px 28px rgba(0, 0, 0, 0.15);
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 24px;
            --radius-full: 9999px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f5f7ff 0%, #f0f2ff 100%);
            color: var(--dark);
            line-height: 1.5;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        /* Header mejorado */
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow-md);
            position: relative;
            z-index: 100;
        }
        
        .header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--accent), var(--success));
        }
        
        .profile-section {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .avatar-container {
            position: relative;
        }
        
        .profile-avatar {
            width: 50px;
            height: 50px;
            border-radius: var(--radius-full);
            object-fit: cover;
            border: 3px solid rgba(255, 255, 255, 0.3);
            box-shadow: var(--shadow-sm);
        }
        
        .online-status {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 12px;
            height: 12px;
            background-color: var(--success);
            border: 2px solid white;
            border-radius: var(--radius-full);
        }
        
        .profile-info h1 {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 0.1rem;
        }
        
        .profile-info p {
            font-size: 0.85rem;
            opacity: 0.9;
            font-weight: 500;
        }
        
        .badge {
            display: inline-flex;
            align-items: center;
            background: rgba(255, 255, 255, 0.2);
            padding: 0.25rem 0.6rem;
            border-radius: var(--radius-full);
            font-size: 0.75rem;
            margin-top: 0.2rem;
        }
        
        .badge i {
            margin-right: 0.3rem;
            font-size: 0.7rem;
        }
        
        .settings-btn {
            background: rgba(255, 255, 255, 0.15);
            border: none;
            width: 44px;
            height: 44px;
            border-radius: var(--radius-full);
            color: white;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow-sm);
        }
        
        .settings-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: rotate(90deg);
        }
        
        /* Contenedor del chat mejorado */
        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1.2rem;
            background-color: transparent;
        }
        
        /* Mensaje del bot mejorado */
        .bot-message {
            align-self: flex-start;
            max-width: 85%;
            animation: messageAppear 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        .bot-message-wrapper {
            display: flex;
            gap: 0.8rem;
            align-items: flex-start;
        }
        
        .bot-avatar {
            width: 36px;
            height: 36px;
            border-radius: var(--radius-full);
            object-fit: cover;
            flex-shrink: 0;
            box-shadow: var(--shadow-sm);
        }
        
        .bot-message-content {
            background-color: var(--bot-bubble);
            padding: 1rem 1.2rem;
            border-radius: 0 var(--radius-lg) var(--radius-lg) var(--radius-lg);
            box-shadow: var(--shadow-sm);
            position: relative;
            flex-grow: 1;
        }
        
        .bot-message-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: -8px;
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 0 8px 8px 0;
            border-color: transparent var(--bot-bubble) transparent transparent;
        }
        
        .bot-name {
            font-weight: 700;
            font-size: 0.9rem;
            color: var(--secondary);
            margin-bottom: 0.3rem;
        }
        
        .bot-text {
            font-size: 1rem;
            line-height: 1.5;
            color: var(--dark);
        }
        
        /* Mensaje del usuario mejorado */
        .user-message {
            align-self: flex-end;
            max-width: 85%;
            animation: messageAppear 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        .user-message-wrapper {
            display: flex;
            gap: 0.8rem;
            align-items: flex-start;
            flex-direction: row-reverse;
        }
        
        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: var(--radius-full);
            object-fit: cover;
            flex-shrink: 0;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            box-shadow: var(--shadow-sm);
        }
        
        .user-message-content {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 1rem 1.2rem;
            border-radius: var(--radius-lg) 0 var(--radius-lg) var(--radius-lg);
            box-shadow: var(--shadow-sm);
            position: relative;
            flex-grow: 1;
        }
        
        .user-message-content::before {
            content: '';
            position: absolute;
            top: 0;
            right: -8px;
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 0 0 8px 8px;
            border-color: transparent transparent transparent var(--primary-dark);
        }
        
        .user-text {
            font-size: 1rem;
            line-height: 1.5;
        }
        
        /* Corrección de errores mejorada */
        .correction-container {
            background: linear-gradient(135deg, #fff5f7 0%, #ffeef2 100%);
            border-left: 4px solid var(--error);
            padding: 0.8rem 1rem;
            border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
            margin-bottom: 0.8rem;
            box-shadow: var(--shadow-sm);
        }
        
        .correction-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--error);
            margin-bottom: 0.4rem;
        }
        
        .correction-title i {
            font-size: 0.9rem;
        }
        
        .error-text {
            color: var(--error);
            font-size: 0.95rem;
            text-decoration: line-through;
            margin-bottom: 0.2rem;
            padding-left: 1.5rem;
        }
        
        .correction-text {
            color: var(--success);
            font-size: 1rem;
            font-weight: 500;
            padding-left: 1.5rem;
        }
        
        /* Recomendación natural */
        .recommendation-container {
            background: linear-gradient(135deg, #f0f9ff 0%, #e6f7ff 100%);
            border-left: 4px solid var(--success);
            padding: 0.8rem 1rem;
            border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
            margin-top: 0.8rem;
            box-shadow: var(--shadow-sm);
        }
        
        .recommendation-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--success);
            margin-bottom: 0.4rem;
        }
        
        .recommendation-title i {
            font-size: 0.9rem;
        }
        
        .recommendation-text {
            color: var(--dark);
            font-size: 0.95rem;
            font-style: italic;
            padding-left: 1.5rem;
        }
        
        /* Botón de traducción mejorado */
        .translation-btn {
            background: white;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
            box-shadow: var(--shadow-sm);
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            margin-top: 0.5rem;
            margin-left: 44px;
        }
        
        .translation-btn:hover {
            transform: scale(1.1);
            box-shadow: var(--shadow-md);
            color: var(--secondary);
        }
        
        /* Área de entrada mejorada */
        .input-area {
            padding: 1.2rem 1.5rem;
            background: white;
            border-top: 1px solid var(--light-gray);
            box-shadow: 0 -4px 16px rgba(0, 0, 0, 0.05);
            z-index: 10;
        }
        
        .mic-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.8rem;
        }
        
        .wave-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 3px;
            height: 24px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .wave-container.active {
            opacity: 1;
        }
        
        .wave-bar {
            width: 3px;
            height: 18px;
            background: linear-gradient(to top, var(--primary), var(--secondary));
            border-radius: 1.5px;
            animation: wave 1s ease-in-out infinite;
        }
        
        .wave-bar:nth-child(1) { animation-delay: 0s; }
        .wave-bar:nth-child(2) { animation-delay: 0.1s; }
        .wave-bar:nth-child(3) { animation-delay: 0.2s; }
        .wave-bar:nth-child(4) { animation-delay: 0.3s; }
        .wave-bar:nth-child(5) { animation-delay: 0.4s; }
        
        @keyframes wave {
            0%, 100% { transform: scaleY(0.3); }
            50% { transform: scaleY(1); }
        }
        
        .status-indicator {
            text-align: center;
            font-size: 0.9rem;
            color: var(--gray);
            min-height: 1.2rem;
            font-weight: 500;
        }
        
        .mic-btn {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            border: none;
            width: 68px;
            height: 68px;
            border-radius: var(--radius-full);
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: var(--shadow-lg);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .mic-btn::after {
            content: '';
            position: absolute;
            top: -6px;
            left: -6px;
            right: -6px;
            bottom: -6px;
            border-radius: var(--radius-full);
            border: 2px solid rgba(67, 97, 238, 0.2);
            pointer-events: none;
        }
        
        .mic-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 30px rgba(67, 97, 238, 0.3);
        }
        
        .mic-btn.recording {
            background: linear-gradient(135deg, var(--accent) 0%, #ff2d95 100%);
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { 
                box-shadow: 0 0 0 0 rgba(247, 37, 133, 0.7);
            }
            70% { 
                box-shadow: 0 0 0 12px rgba(247, 37, 133, 0);
            }
            100% { 
                box-shadow: 0 0 0 0 rgba(247, 37, 133, 0);
            }
        }
        
        .mic-btn.send-mode {
            background: linear-gradient(135deg, var(--success) 0%, #2bc9ef 100%);
        }
        
        .mic-btn i {
            transition: transform 0.3s ease;
        }
        
        /* Modal de configuración mejorado */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .modal {
            background-color: white;
            width: 90%;
            max-width: 480px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            overflow: hidden;
            transform: translateY(30px) scale(0.95);
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        .modal-overlay.active .modal {
            transform: translateY(0) scale(1);
        }
        
        .modal-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 1.5rem;
            text-align: center;
        }
        
        .modal-header h2 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.3rem;
        }
        
        .modal-header p {
            opacity: 0.9;
            font-size: 0.9rem;
        }
        
        .modal-body {
            padding: 1.5rem;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--dark);
            font-size: 0.95rem;
        }
        
        .form-group input {
            width: 100%;
            padding: 0.9rem 1rem;
            border: 1px solid var(--light-gray);
            border-radius: var(--radius-md);
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
            transition: all 0.3s ease;
            background-color: #fafbff;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
        }
        
        .api-info {
            font-size: 0.85rem;
            color: var(--gray);
            margin-top: 0.5rem;
            line-height: 1.4;
        }
        
        .api-info a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 600;
        }
        
        .api-info a:hover {
            text-decoration: underline;
        }
        
        .modal-footer {
            padding: 1.2rem 1.5rem;
            background-color: #f8f9ff;
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            border-top: 1px solid var(--light-gray);
        }
        
        .btn {
            padding: 0.8rem 1.8rem;
            border-radius: var(--radius-md);
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.3s ease;
            font-size: 0.95rem;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            box-shadow: var(--shadow-sm);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .btn-secondary {
            background-color: white;
            color: var(--gray);
            border: 1px solid var(--light-gray);
        }
        
        .btn-secondary:hover {
            background-color: var(--light-gray);
        }
        
        /* Animaciones */
        @keyframes messageAppear {
            from { 
                opacity: 0; 
                transform: translateY(15px) scale(0.95); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0) scale(1); 
            }
        }
        
        /* Scrollbar personalizada */
        .chat-container::-webkit-scrollbar {
            width: 6px;
        }
        
        .chat-container::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.05);
            border-radius: 10px;
        }
        
        .chat-container::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            border-radius: 10px;
        }
        
        /* Responsive mejorado para móviles */
        @media (max-width: 768px) {
            .header {
                padding: 1rem;
            }
            
            .profile-avatar {
                width: 44px;
                height: 44px;
            }
            
            .profile-info h1 {
                font-size: 1.1rem;
            }
            
            .profile-info p {
                font-size: 0.8rem;
            }
            
            .chat-container {
                padding: 1rem;
                gap: 1rem;
            }
            
            .bot-message, .user-message {
                max-width: 90%;
            }
            
            .input-area {
                padding: 1rem;
            }
            
            .mic-btn {
                width: 64px;
                height: 64px;
                font-size: 1.4rem;
            }
            
            .modal {
                width: 95%;
            }
            
            .modal-body {
                padding: 1.2rem;
            }
        }
        
        @media (max-width: 480px) {
            .bot-message-wrapper, .user-message-wrapper {
                gap: 0.6rem;
            }
            
            .bot-avatar, .user-avatar {
                width: 32px;
                height: 32px;
            }
            
            .bot-message-content, .user-message-content {
                padding: 0.8rem 1rem;
            }
            
            .bot-text, .user-text {
                font-size: 0.95rem;
            }
        }
        
        /* Indicador de grabación */
        .recording-indicator {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            gap: 0.8rem;
            z-index: 500;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-lg);
        }
        
        .recording-indicator.active {
            opacity: 1;
            visibility: visible;
        }
        
        .recording-dot {
            width: 12px;
            height: 12px;
            background-color: var(--accent);
            border-radius: var(--radius-full);
            animation: recordingBlink 1.5s infinite;
        }
        
        @keyframes recordingBlink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        
        /* Mejora para el placeholder del chat */
        .chat-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--gray);
            text-align: center;
            padding: 2rem;
        }
        
        .chat-placeholder i {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: var(--light-gray);
        }
        
        .chat-placeholder h3 {
            font-size: 1.2rem;
            margin-bottom: 0.5rem;
            color: var(--dark);
        }
        
        .chat-placeholder p {
            max-width: 300px;
            line-height: 1.5;
        }
    </style>
</head>
<body>
    <!-- Header mejorado -->
    <header class="header">
        <div class="profile-section">
            <div class="avatar-container">
                <img src="https://images.unsplash.com/photo-1568602471122-7832951cc4c5?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=80" alt="Prof. Sterling" class="profile-avatar">
                <div class="online-status"></div>
            </div>
            <div class="profile-info">
                <h1>Prof. Sterling</h1>
                <p>AI English Tutor</p>
                <div class="badge">
                    <i class="fas fa-volume-up"></i>
                    <span>Voice Assistant</span>
                </div>
            </div>
        </div>
        <button class="settings-btn" id="settingsBtn">
            <i class="fas fa-cog"></i>
        </button>
    </header>
    
    <!-- Contenedor del chat -->
    <div class="chat-container" id="chatContainer">
        <!-- Solo un mensaje inicial del bot -->
        <div class="bot-message">
            <div class="bot-message-wrapper">
                <img src="https://images.unsplash.com/photo-1568602471122-7832951cc4c5?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=80" alt="Prof. Sterling" class="bot-avatar">
                <div class="bot-message-content">
                    <div class="bot-name">Prof. Sterling</div>
                    <div class="bot-text">
                        Hello! I'm Professor Sterling, your AI English tutor. I'm here to help you practice English conversation. 
                        I'll listen to you speak, provide corrections when needed, and give you tips for more natural expressions. 
                        Press and hold the microphone button to start speaking, then release to send your message.
                    </div>
                </div>
            </div>
            <button class="translation-btn" title="Translate to Spanish">
                <i class="fas fa-language"></i>
            </button>
        </div>
    </div>
    
    <!-- Indicador de grabación -->
    <div class="recording-indicator" id="recordingIndicator">
        <div class="recording-dot"></div>
        <span>Listening... Speak now</span>
    </div>
    
    <!-- Área de entrada mejorada -->
    <div class="input-area">
        <div class="mic-container">
            <div class="wave-container" id="waveContainer">
                <div class="wave-bar"></div>
                <div class="wave-bar"></div>
                <div class="wave-bar"></div>
                <div class="wave-bar"></div>
                <div class="wave-bar"></div>
            </div>
            
            <div class="status-indicator" id="statusIndicator">
                Press and hold to speak
            </div>
            
            <button class="mic-btn" id="micBtn">
                <i class="fas fa-microphone"></i>
            </button>
        </div>
    </div>
    
    <!-- Modal de configuración mejorado -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal">
            <div class="modal-header">
                <h2>API Configuration</h2>
                <p>Set up your Gemini API key to enable AI features</p>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="apiKey">Gemini API Key</label>
                    <input type="password" id="apiKey" placeholder="Enter your Gemini API key">
                    <p class="api-info">
                        You need a free API key from Google AI Studio. 
                        <a href="https://makersuite.google.com/app/apikey" target="_blank">Get your key here</a>
                    </p>
                </div>
                <div class="form-group">
                    <label for="userName">Your Name</label>
                    <input type="text" id="userName" placeholder="Example: Alejandro" value="Alejandro">
                </div>
                <div class="form-group">
                    <label for="voiceSpeed">Voice Speed</label>
                    <input type="range" id="voiceSpeed" min="0.5" max="1.5" step="0.1" value="1.0">
                    <p class="api-info" id="voiceSpeedValue">Speed: Normal</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="closeModal">Cancel</button>
                <button class="btn btn-primary" id="saveSettings">Save Settings</button>
            </div>
        </div>
    </div>
    
    <script>
        // DOM Elements
        const chatContainer = document.getElementById('chatContainer');
        const micBtn = document.getElementById('micBtn');
        const micIcon = micBtn.querySelector('i');
        const waveContainer = document.getElementById('waveContainer');
        const statusIndicator = document.getElementById('statusIndicator');
        const recordingIndicator = document.getElementById('recordingIndicator');
        const settingsBtn = document.getElementById('settingsBtn');
        const modalOverlay = document.getElementById('modalOverlay');
        const closeModal = document.getElementById('closeModal');
        const saveSettings = document.getElementById('saveSettings');
        const apiKeyInput = document.getElementById('apiKey');
        const userNameInput = document.getElementById('userName');
        const voiceSpeedInput = document.getElementById('voiceSpeed');
        const voiceSpeedValue = document.getElementById('voiceSpeedValue');
        
        // Application state
        let isRecording = false;
        let isSendMode = false;
        let mediaRecorder = null;
        let audioChunks = [];
        let recognition = null;
        let apiKey = '';
        let userName = 'Alejandro';
        let voiceSpeed = 1.0;
        let messageCount = 0;
        let correctionCount = 0;
        
        // Check for Web Speech API support
        const isSpeechRecognitionSupported = 'webkitSpeechRecognition' in window || 'SpeechRecognition' in window;
        
        // Initialize speech recognition if supported
        if (isSpeechRecognitionSupported) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = false;
            recognition.lang = 'en-US';
            
            recognition.onresult = (event) => {
                const transcript = event.results[event.results.length - 1][0].transcript;
                addUserMessage(transcript);
                processUserInput(transcript);
            };
            
            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                statusIndicator.textContent = 'Voice recognition error';
                resetRecordingState();
                recordingIndicator.classList.remove('active');
            };
            
            recognition.onend = () => {
                if (isRecording) {
                    // If still recording (user hasn't stopped), restart recognition
                    recognition.start();
                }
            };
        } else {
            statusIndicator.textContent = 'Voice recognition not supported in this browser';
            micBtn.disabled = true;
        }
        
        // Initialize from localStorage
        function initFromStorage() {
            const savedApiKey = localStorage.getItem('geminiApiKey');
            const savedUserName = localStorage.getItem('userName');
            const savedVoiceSpeed = localStorage.getItem('voiceSpeed');
            
            if (savedApiKey) {
                apiKeyInput.value = savedApiKey;
                apiKey = savedApiKey;
            }
            
            if (savedUserName) {
                userNameInput.value = savedUserName;
                userName = savedUserName;
            }
            
            if (savedVoiceSpeed) {
                voiceSpeedInput.value = savedVoiceSpeed;
                voiceSpeed = parseFloat(savedVoiceSpeed);
                updateVoiceSpeedValue();
            }
        }
        
        // Update voice speed display
        function updateVoiceSpeedValue() {
            let speedText = 'Normal';
            if (voiceSpeed < 0.9) speedText = 'Slow';
            if (voiceSpeed > 1.1) speedText = 'Fast';
            voiceSpeedValue.textContent = `Speed: ${speedText} (${voiceSpeed.toFixed(1)}x)`;
        }
        
        // Start recording
        function startRecording() {
            if (!isSpeechRecognitionSupported) return;
            
            isRecording = true;
            isSendMode = false;
            micBtn.classList.add('recording');
            waveContainer.classList.add('active');
            recordingIndicator.classList.add('active');
            statusIndicator.textContent = 'Listening... Release to send';
            micIcon.className = 'fas fa-microphone';
            
            // Start speech recognition
            try {
                recognition.start();
            } catch (error) {
                console.error('Error starting speech recognition:', error);
            }
        }
        
        // Stop recording and send
        function stopRecording() {
            isRecording = false;
            isSendMode = true;
            micBtn.classList.remove('recording');
            micBtn.classList.add('send-mode');
            waveContainer.classList.remove('active');
            recordingIndicator.classList.remove('active');
            statusIndicator.textContent = 'Ready to send. Tap to send or hold to record again';
            micIcon.className = 'fas fa-paper-plane';
            
            // Stop speech recognition
            if (recognition) {
                recognition.stop();
            }
        }
        
        // Reset to initial state
        function resetRecordingState() {
            isRecording = false;
            isSendMode = false;
            micBtn.classList.remove('recording', 'send-mode');
            waveContainer.classList.remove('active');
            recordingIndicator.classList.remove('active');
            statusIndicator.textContent = 'Press and hold to speak';
            micIcon.className = 'fas fa-microphone';
        }
        
        // Add user message to chat
        function addUserMessage(text) {
            const userInitial = userName.charAt(0).toUpperCase();
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'user-message';
            messageDiv.innerHTML = `
                <div class="user-message-wrapper">
                    <div class="user-avatar">${userInitial}</div>
                    <div class="user-message-content">
                        <div class="user-text">${text}</div>
                    </div>
                </div>
                <button class="translation-btn" title="Translate to Spanish" onclick="translateMessage(this, '${text.replace(/'/g, "\\'")}')">
                    <i class="fas fa-language"></i>
                </button>
            `;
            
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            messageCount++;
        }
        
        // Add bot message to chat with optional correction and recommendation
        function addBotMessage(content, correction = null, recommendation = null) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'bot-message';
            
            let correctionHTML = '';
            if (correction) {
                correctionHTML = `
                    <div class="correction-container">
                        <div class="correction-title">
                            <i class="fas fa-exclamation-circle"></i>
                            <span>Correction</span>
                        </div>
                        <div class="error-text">${correction.error}</div>
                        <div class="correction-text">${correction.correction}</div>
                    </div>
                `;
                correctionCount++;
            }
            
            let recommendationHTML = '';
            if (recommendation) {
                recommendationHTML = `
                    <div class="recommendation-container">
                        <div class="recommendation-title">
                            <i class="fas fa-lightbulb"></i>
                            <span>Natural Expression Tip</span>
                        </div>
                        <div class="recommendation-text">${recommendation}</div>
                    </div>
                `;
            }
            
            messageDiv.innerHTML = `
                <div class="bot-message-wrapper">
                    <img src="https://images.unsplash.com/photo-1568602471122-7832951cc4c5?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=80" alt="Prof. Sterling" class="bot-avatar">
                    <div class="bot-message-content">
                        <div class="bot-name">Prof. Sterling</div>
                        ${correctionHTML}
                        <div class="bot-text">${content}</div>
                        ${recommendationHTML}
                    </div>
                </div>
                <button class="translation-btn" title="Translate to Spanish" onclick="translateMessage(this, '${content.replace(/'/g, "\\'")}')">
                    <i class="fas fa-language"></i>
                </button>
            `;
            
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            // Speak the bot's response with improved voice
            speakText(content);
        }
        
        // Process user input and get bot response
        async function processUserInput(userText) {
            if (!userText.trim()) return;
            
            // Show typing indicator
            statusIndicator.textContent = 'Prof. Sterling is typing...';
            
            try {
                // Check for errors and get corrections
                const correction = checkForErrors(userText);
                
                // Determine if we should give a recommendation (every 3-5 messages)
                const shouldGiveRecommendation = messageCount > 0 && 
                                               (messageCount % Math.floor(Math.random() * 3 + 3) === 0);
                
                // Get a recommendation if needed
                const recommendation = shouldGiveRecommendation ? getNaturalExpressionTip() : null;
                
                // Generate a response based on the user's input
                const response = generateBotResponse(userText, correction, recommendation);
                
                // Add the bot's response
                addBotMessage(response, correction, recommendation);
                statusIndicator.textContent = 'Press and hold to speak';
            } catch (error) {
                console.error('Error processing input:', error);
                addBotMessage("I'm having trouble connecting right now. Please check your API key and try again.");
                statusIndicator.textContent = 'Connection error';
            } finally {
                resetRecordingState();
            }
        }
        
        // Check for common English errors in user text
        function checkForErrors(text) {
            const errorPatterns = [
                { 
                    pattern: /\bgender\b.*\bmusic\b/i, 
                    error: "gender of music",
                    correction: "genre of music"
                },
                { 
                    pattern: /\bi enjoyed\b.*\bit because that\b/i, 
                    error: "I enjoyed it because that",
                    correction: "I enjoy it because the"
                },
                { 
                    pattern: /\bi have went\b/i, 
                    error: "I have went",
                    correction: "I have gone"
                },
                { 
                    pattern: /\bshe don't\b/i, 
                    error: "she don't",
                    correction: "she doesn't"
                },
                { 
                    pattern: /\bmore better\b/i, 
                    error: "more better",
                    correction: "better"
                },
                { 
                    pattern: /\bgooder\b/i, 
                    error: "gooder",
                    correction: "better"
                },
                { 
                    pattern: /\bi am agree\b/i, 
                    error: "I am agree",
                    correction: "I agree"
                },
                { 
                    pattern: /\bfor explain\b/i, 
                    error: "for explain",
                    correction: "to explain"
                },
                { 
                    pattern: /\bmuch better\b/i, 
                    error: "much better",
                    correction: "much better" // Esta es correcta, pero la incluimos para ejemplo
                }
            ];
            
            for (const pattern of errorPatterns) {
                if (pattern.pattern.test(text)) {
                    return {
                        error: pattern.error,
                        correction: pattern.correction
                    };
                }
            }
            
            return null;
        }
        
        // Generate natural expression tips
        function getNaturalExpressionTip() {
            const tips = [
                "Instead of 'I think that...', native speakers often say 'I reckon...' or 'I believe...'",
                "A more natural way to say 'very good' is 'awesome', 'fantastic', or 'brilliant'",
                "Instead of 'I don't know', you can say 'I'm not sure' or 'I have no idea'",
                "Native speakers often use contractions like 'gonna' for 'going to' and 'wanna' for 'want to' in informal speech",
                "Instead of 'very tired', say 'exhausted' or 'worn out' for more natural English",
                "Use 'kind of' or 'sort of' instead of 'a little' for a more natural sound",
                "Instead of 'I need to...', you can say 'I gotta...' in informal conversations",
                "A common expression for agreement is 'You can say that again!' instead of just 'I agree'"
            ];
            
            return tips[Math.floor(Math.random() * tips.length)];
        }
        
        // Generate bot response based on user input
        function generateBotResponse(userText, correction, recommendation) {
            const lowerText = userText.toLowerCase();
            
            // Greetings
            if (lowerText.includes('hello') || lowerText.includes('hi') || lowerText.includes('hey')) {
                return `Hello ${userName}! How are you doing today? I'm here to help you practice your English.`;
            }
            
            // How are you
            if (lowerText.includes('how are you')) {
                return "I'm doing well, thank you for asking! As an AI, I don't have feelings, but I'm always ready to help you learn English.";
            }
            
            // Music
            if (lowerText.includes('music') || lowerText.includes('song') || lowerText.includes('genre')) {
                return "Music is a great topic! I enjoy classical music myself, but I also appreciate good pop and rock songs. What specific artists or bands do you like?";
            }
            
            // Favorite
            if (lowerText.includes('favorite') || lowerText.includes('favourite')) {
                return "That's interesting! I'm glad you shared that with me. Could you tell me more about why you like it?";
            }
            
            // Thank you
            if (lowerText.includes('thank you') || lowerText.includes('thanks')) {
                return "You're very welcome! I'm happy to help you improve your English skills.";
            }
            
            // Goodbye
            if (lowerText.includes('bye') || lowerText.includes('goodbye') || lowerText.includes('see you')) {
                return "Goodbye! It was great practicing English with you. Come back anytime you want to practice more!";
            }
            
            // Weather
            if (lowerText.includes('weather')) {
                return "The weather is a common conversation topic in English. People often say things like 'Lovely day, isn't it?' or 'Bit chilly today!' to start conversations.";
            }
            
            // Food
            if (lowerText.includes('food') || lowerText.includes('eat') || lowerText.includes('restaurant')) {
                return "Food is one of my favorite topics! In English, people might say 'I'm starving' instead of 'I'm very hungry', or 'That looks delicious' when they see good food.";
            }
            
            // Default response with encouragement
            const encouragements = [
                `Thanks for sharing that, ${userName}. I appreciate you practicing English with me.`,
                `That's interesting, ${userName}. Keep practicing and you'll keep improving!`,
                `Great effort, ${userName}! The more you practice, the more natural your English will sound.`,
                `Good job expressing yourself, ${userName}! Let's keep the conversation going.`
            ];
            
            const randomEncouragement = encouragements[Math.floor(Math.random() * encouragements.length)];
            
            if (correction) {
                return `${randomEncouragement} Don't worry about mistakes - they're a normal part of learning!`;
            }
            
            return `${randomEncouragement} Can you tell me more about your day or interests?`;
        }
        
        // Improved text-to-speech function with male voice
        function speakText(text) {
            if ('speechSynthesis' in window) {
                // Cancel any ongoing speech
                speechSynthesis.cancel();
                
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'en-US';
                utterance.rate = voiceSpeed;
                utterance.pitch = 0.9; // Lower pitch for more masculine sound
                utterance.volume = 1;
                
                // Get available voices
                const voices = speechSynthesis.getVoices();
                
                // Try to find a male voice
                let maleVoice = voices.find(voice => 
                    voice.lang.startsWith('en-') && 
                    (voice.name.toLowerCase().includes('male') || 
                     voice.name.toLowerCase().includes('man') ||
                     voice.name.includes('Google UK English Male') ||
                     voice.name.includes('Microsoft David'))
                );
                
                // If no male voice found, try to find a deeper voice
                if (!maleVoice) {
                    maleVoice = voices.find(voice => 
                        voice.lang.startsWith('en-') && 
                        !voice.name.toLowerCase().includes('female') &&
                        !voice.name.toLowerCase().includes('woman') &&
                        !voice.name.toLowerCase().includes('susan') &&
                        !voice.name.toLowerCase().includes('zira')
                    );
                }
                
                // If still no voice found, use the first English voice
                if (!maleVoice) {
                    maleVoice = voices.find(voice => voice.lang.startsWith('en-'));
                }
                
                if (maleVoice) {
                    utterance.voice = maleVoice;
                }
                
                // Speak the text
                speechSynthesis.speak(utterance);
            }
        }
        
        // Load voices when they become available
        if ('speechSynthesis' in window) {
            speechSynthesis.onvoiceschanged = function() {
                // Voices are now loaded
            };
        }
        
        // Translate message
        function translateMessage(button, text) {
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            button.disabled = true;
            
            // Simulate translation API call
            setTimeout(() => {
                button.innerHTML = '<i class="fas fa-language"></i>';
                button.disabled = false;
                
                // Show a temporary notification
                showNotification(`Translated to Spanish: "${text.substring(0, 40)}${text.length > 40 ? '...' : ''}"`);
            }, 800);
        }
        
        // Show notification
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.textContent = message;
            notification.style.cssText = `
                position: fixed;
                bottom: 120px;
                left: 50%;
                transform: translateX(-50%);
                background: var(--primary);
                color: white;
                padding: 12px 18px;
                border-radius: var(--radius-md);
                z-index: 1000;
                max-width: 80%;
                text-align: center;
                box-shadow: var(--shadow-lg);
                font-weight: 500;
                font-size: 0.9rem;
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    document.body.removeChild(notification);
                }
            }, 3000);
        }
        
        // Event Listeners
        micBtn.addEventListener('mousedown', () => {
            if (!isSendMode) {
                startRecording();
            }
        });
        
        micBtn.addEventListener('mouseup', () => {
            if (isRecording && !isSendMode) {
                stopRecording();
            } else if (isSendMode) {
                const lastUserMessage = document.querySelector('.user-message:last-child .user-text');
                if (lastUserMessage) {
                    processUserInput(lastUserMessage.textContent);
                } else {
                    resetRecordingState();
                }
            }
        });
        
        // For touch devices
        micBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            if (!isSendMode) {
                startRecording();
            }
        });
        
        micBtn.addEventListener('touchend', (e) => {
            e.preventDefault();
            if (isRecording && !isSendMode) {
                stopRecording();
            } else if (isSendMode) {
                const lastUserMessage = document.querySelector('.user-message:last-child .user-text');
                if (lastUserMessage) {
                    processUserInput(lastUserMessage.textContent);
                } else {
                    resetRecordingState();
                }
            }
        });
        
        // Voice speed input
        voiceSpeedInput.addEventListener('input', () => {
            voiceSpeed = parseFloat(voiceSpeedInput.value);
            updateVoiceSpeedValue();
        });
        
        // Settings modal
        settingsBtn.addEventListener('click', () => {
            modalOverlay.classList.add('active');
        });
        
        closeModal.addEventListener('click', () => {
            modalOverlay.classList.remove('active');
        });
        
        saveSettings.addEventListener('click', () => {
            apiKey = apiKeyInput.value.trim();
            userName = userNameInput.value.trim() || 'Alejandro';
            voiceSpeed = parseFloat(voiceSpeedInput.value);
            
            // Save to localStorage
            localStorage.setItem('geminiApiKey', apiKey);
            localStorage.setItem('userName', userName);
            localStorage.setItem('voiceSpeed', voiceSpeed);
            
            updateVoiceSpeedValue();
            modalOverlay.classList.remove('active');
            
            // Show confirmation
            showNotification('Settings saved successfully!');
        });
        
        // Close modal when clicking outside
        modalOverlay.addEventListener('click', (e) => {
            if (e.target === modalOverlay) {
                modalOverlay.classList.remove('active');
            }
        });
        
        // Initialize the app
        function initApp() {
            initFromStorage();
            
            // Add a welcome message after a short delay
            setTimeout(() => {
                addBotMessage(`Welcome ${userName}! I'm Professor Sterling, your AI English tutor. I'm here to help you practice English conversation. I'll listen to you speak, provide corrections when needed, and give you tips for more natural expressions. Let's start with a simple question: How are you today?`);
            }, 1500);
        }
        
        // Initialize the app when page loads
        window.addEventListener('DOMContentLoaded', initApp);
        
        // Prevent context menu on long press for mobile
        document.addEventListener('contextmenu', (e) => {
            if (e.target === micBtn) {
                e.preventDefault();
            }
        });
    </script>
</body>
</html>
