<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Bot - Profesor de Inglés</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap">
    <style>
        :root {
            --primary-color: #4a6fa5;
            --secondary-color: #6b8cbc;
            --accent-color: #ff6b6b;
            --success-color: #51cf66;
            --error-color: #ff6b6b;
            --text-color: #333;
            --light-gray: #f8f9fa;
            --medium-gray: #e9ecef;
            --dark-gray: #adb5bd;
            --chat-user-bg: #e3f2fd;
            --chat-bot-bg: #f8f9fa;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --border-radius: 12px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f5f7fb;
            color: var(--text-color);
            line-height: 1.6;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            z-index: 10;
            position: relative;
        }
        
        .profile-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .profile-img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid rgba(255, 255, 255, 0.3);
        }
        
        .profile-text h1 {
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        .profile-text p {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .settings-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .settings-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(30deg);
        }
        
        /* Chat Container */
        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        
        .message {
            max-width: 85%;
            padding: 1rem;
            border-radius: var(--border-radius);
            position: relative;
            box-shadow: var(--shadow);
            animation: fadeIn 0.3s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .user-message {
            align-self: flex-end;
            background-color: var(--chat-user-bg);
            border-bottom-right-radius: 4px;
        }
        
        .bot-message {
            align-self: flex-start;
            background-color: var(--chat-bot-bg);
            border-bottom-left-radius: 4px;
        }
        
        .message-header {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
            gap: 0.5rem;
        }
        
        .bot-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            object-fit: cover;
        }
        
        .message-sender {
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .user-message .message-sender {
            color: var(--primary-color);
        }
        
        .bot-message .message-sender {
            color: #d6336c;
        }
        
        .message-content {
            font-size: 1rem;
            line-height: 1.5;
        }
        
        .correction-container {
            margin-bottom: 0.8rem;
            padding: 0.8rem;
            border-radius: 8px;
            background-color: rgba(255, 255, 255, 0.9);
            border-left: 4px solid var(--error-color);
        }
        
        .error-text {
            color: var(--error-color);
            font-size: 0.9rem;
            margin-bottom: 0.3rem;
            text-decoration: line-through;
        }
        
        .correction-text {
            color: var(--success-color);
            font-size: 0.95rem;
            font-weight: 500;
        }
        
        .translation-btn {
            position: absolute;
            bottom: -8px;
            right: -8px;
            background: white;
            border: none;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-color);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s ease;
        }
        
        .translation-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.2);
        }
        
        /* Input Area */
        .input-area {
            padding: 1.5rem;
            background-color: white;
            border-top: 1px solid var(--medium-gray);
            display: flex;
            flex-direction: column;
            gap: 1rem;
            z-index: 5;
        }
        
        .mic-container {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .mic-btn {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border: none;
            width: 70px;
            height: 70px;
            border-radius: 50%;
            color: white;
            font-size: 1.8rem;
            cursor: pointer;
            box-shadow: 0 6px 20px rgba(74, 111, 165, 0.3);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .mic-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(74, 111, 165, 0.4);
        }
        
        .mic-btn.recording {
            background: linear-gradient(135deg, #ff4757, #ff6b6b);
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 107, 107, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(255, 107, 107, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 107, 107, 0); }
        }
        
        .mic-btn.send-mode {
            background: linear-gradient(135deg, var(--success-color), #40c057);
        }
        
        .mic-btn i {
            transition: transform 0.3s ease;
        }
        
        .status-indicator {
            text-align: center;
            font-size: 0.9rem;
            color: var(--dark-gray);
            min-height: 1.2rem;
        }
        
        /* Wave Animation */
        .wave-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 4px;
            height: 30px;
            margin-bottom: 0.5rem;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .wave-container.active {
            opacity: 1;
        }
        
        .wave-bar {
            width: 4px;
            height: 20px;
            background: linear-gradient(to top, var(--primary-color), var(--secondary-color));
            border-radius: 2px;
            animation: wave 1.2s ease-in-out infinite;
        }
        
        .wave-bar:nth-child(2) { animation-delay: 0.1s; }
        .wave-bar:nth-child(3) { animation-delay: 0.2s; }
        .wave-bar:nth-child(4) { animation-delay: 0.3s; }
        .wave-bar:nth-child(5) { animation-delay: 0.4s; }
        
        @keyframes wave {
            0%, 100% { transform: scaleY(0.5); }
            50% { transform: scaleY(1.5); }
        }
        
        /* Settings Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .modal {
            background-color: white;
            width: 90%;
            max-width: 500px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            transform: translateY(20px);
            transition: transform 0.3s ease;
        }
        
        .modal-overlay.active .modal {
            transform: translateY(0);
        }
        
        .modal-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 1.5rem;
        }
        
        .modal-header h2 {
            font-size: 1.5rem;
            font-weight: 600;
        }
        
        .modal-body {
            padding: 1.5rem;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }
        
        .form-group input {
            width: 100%;
            padding: 0.8rem 1rem;
            border: 1px solid var(--medium-gray);
            border-radius: 8px;
            font-family: 'Poppins', sans-serif;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        
        .api-info {
            font-size: 0.85rem;
            color: var(--dark-gray);
            margin-top: 0.5rem;
        }
        
        .modal-footer {
            padding: 1rem 1.5rem;
            background-color: var(--light-gray);
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }
        
        .btn {
            padding: 0.7rem 1.5rem;
            border-radius: 8px;
            font-family: 'Poppins', sans-serif;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: var(--secondary-color);
        }
        
        .btn-secondary {
            background-color: var(--medium-gray);
            color: var(--text-color);
        }
        
        .btn-secondary:hover {
            background-color: var(--dark-gray);
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .message {
                max-width: 90%;
            }
            
            .header {
                padding: 1rem;
            }
            
            .profile-text h1 {
                font-size: 1.1rem;
            }
            
            .profile-text p {
                font-size: 0.8rem;
            }
            
            .chat-container {
                padding: 1rem;
            }
            
            .input-area {
                padding: 1rem;
            }
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--light-gray);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--dark-gray);
            border-radius: 3px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--secondary-color);
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="profile-info">
            <img src="https://images.unsplash.com/photo-1568602471122-7832951cc4c5?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=200&q=80" alt="Prof. Sterling" class="profile-img">
            <div class="profile-text">
                <h1>Prof. Sterling</h1>
                <p>AI English Tutor</p>
            </div>
        </div>
        <button class="settings-btn" id="settingsBtn">
            <i class="fas fa-cog"></i>
        </button>
    </header>
    
    <!-- Chat Container -->
    <div class="chat-container" id="chatContainer">
        <!-- Initial bot message -->
        <div class="message bot-message">
            <div class="message-header">
                <img src="https://images.unsplash.com/photo-1568602471122-7832951cc4c5?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=200&q=80" alt="Prof. Sterling" class="bot-avatar">
                <span class="message-sender">Prof. Sterling</span>
            </div>
            <div class="message-content">
                Hello! I'm Professor Sterling, your AI English tutor. I'm here to help you practice English conversation. I'll listen to you speak and provide corrections when needed. Press and hold the microphone button to start speaking, then release to send your message.
            </div>
            <button class="translation-btn" title="Translate">
                <i class="fas fa-language"></i>
            </button>
        </div>
    </div>
    
    <!-- Input Area -->
    <div class="input-area">
        <div class="wave-container" id="waveContainer">
            <div class="wave-bar"></div>
            <div class="wave-bar"></div>
            <div class="wave-bar"></div>
            <div class="wave-bar"></div>
            <div class="wave-bar"></div>
        </div>
        
        <div class="status-indicator" id="statusIndicator">
            Press and hold the microphone to speak
        </div>
        
        <div class="mic-container">
            <button class="mic-btn" id="micBtn">
                <i class="fas fa-microphone"></i>
            </button>
        </div>
    </div>
    
    <!-- Settings Modal -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal">
            <div class="modal-header">
                <h2>Configuración de API</h2>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="apiKey">Gemini API Key</label>
                    <input type="password" id="apiKey" placeholder="Ingresa tu clave API de Gemini">
                    <p class="api-info">Necesitas una clave API gratuita de Google AI Studio. <a href="https://makersuite.google.com/app/apikey" target="_blank">Obtener clave</a></p>
                </div>
                <div class="form-group">
                    <label for="userName">Tu Nombre</label>
                    <input type="text" id="userName" placeholder="Ej: Alejandro" value="Alejandro">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="closeModal">Cancelar</button>
                <button class="btn btn-primary" id="saveSettings">Guardar</button>
            </div>
        </div>
    </div>
    
    <script>
        // DOM Elements
        const chatContainer = document.getElementById('chatContainer');
        const micBtn = document.getElementById('micBtn');
        const micIcon = micBtn.querySelector('i');
        const waveContainer = document.getElementById('waveContainer');
        const statusIndicator = document.getElementById('statusIndicator');
        const settingsBtn = document.getElementById('settingsBtn');
        const modalOverlay = document.getElementById('modalOverlay');
        const closeModal = document.getElementById('closeModal');
        const saveSettings = document.getElementById('saveSettings');
        const apiKeyInput = document.getElementById('apiKey');
        const userNameInput = document.getElementById('userName');
        
        // Application state
        let isRecording = false;
        let isSendMode = false;
        let mediaRecorder = null;
        let audioChunks = [];
        let recognition = null;
        let apiKey = '';
        let userName = 'Alejandro';
        
        // Check for Web Speech API support
        const isSpeechRecognitionSupported = 'webkitSpeechRecognition' in window || 'SpeechRecognition' in window;
        
        // Initialize speech recognition if supported
        if (isSpeechRecognitionSupported) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = false;
            recognition.lang = 'en-US';
            
            recognition.onresult = (event) => {
                const transcript = event.results[event.results.length - 1][0].transcript;
                addUserMessage(transcript);
                processUserInput(transcript);
            };
            
            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                statusIndicator.textContent = 'Error en reconocimiento de voz';
                resetRecordingState();
            };
            
            recognition.onend = () => {
                if (isRecording) {
                    // If still recording (user hasn't stopped), restart recognition
                    recognition.start();
                }
            };
        } else {
            statusIndicator.textContent = 'El reconocimiento de voz no es compatible con este navegador';
            micBtn.disabled = true;
        }
        
        // Initialize from localStorage
        function initFromStorage() {
            const savedApiKey = localStorage.getItem('geminiApiKey');
            const savedUserName = localStorage.getItem('userName');
            
            if (savedApiKey) {
                apiKeyInput.value = savedApiKey;
                apiKey = savedApiKey;
            }
            
            if (savedUserName) {
                userNameInput.value = savedUserName;
                userName = savedUserName;
            }
        }
        
        // Toggle recording state
        function toggleRecording() {
            if (!isRecording) {
                startRecording();
            } else {
                stopRecording();
            }
        }
        
        // Start recording
        function startRecording() {
            if (!isSpeechRecognitionSupported) return;
            
            isRecording = true;
            isSendMode = false;
            micBtn.classList.add('recording');
            waveContainer.classList.add('active');
            statusIndicator.textContent = 'Escuchando... Habla ahora';
            micIcon.className = 'fas fa-microphone';
            
            // Start speech recognition
            try {
                recognition.start();
            } catch (error) {
                console.error('Error starting speech recognition:', error);
            }
        }
        
        // Stop recording and send
        function stopRecording() {
            isRecording = false;
            isSendMode = true;
            micBtn.classList.remove('recording');
            micBtn.classList.add('send-mode');
            waveContainer.classList.remove('active');
            statusIndicator.textContent = 'Listo para enviar. Toca para enviar o mantén para grabar de nuevo';
            micIcon.className = 'fas fa-paper-plane';
            
            // Stop speech recognition
            if (recognition) {
                recognition.stop();
            }
        }
        
        // Reset to initial state
        function resetRecordingState() {
            isRecording = false;
            isSendMode = false;
            micBtn.classList.remove('recording', 'send-mode');
            waveContainer.classList.remove('active');
            statusIndicator.textContent = 'Presiona y mantén el micrófono para hablar';
            micIcon.className = 'fas fa-microphone';
        }
        
        // Add user message to chat
        function addUserMessage(text) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message user-message';
            messageDiv.innerHTML = `
                <div class="message-header">
                    <span class="message-sender">${userName}</span>
                </div>
                <div class="message-content">${text}</div>
                <button class="translation-btn" title="Translate" onclick="translateMessage(this, '${text}')">
                    <i class="fas fa-language"></i>
                </button>
            `;
            
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
        
        // Add bot message to chat
        function addBotMessage(content, correction = null) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message bot-message';
            
            let correctionHTML = '';
            if (correction) {
                correctionHTML = `
                    <div class="correction-container">
                        <div class="error-text">${correction.error}</div>
                        <div class="correction-text">${correction.correction}</div>
                    </div>
                `;
            }
            
            messageDiv.innerHTML = `
                <div class="message-header">
                    <img src="https://images.unsplash.com/photo-1568602471122-7832951cc4c5?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=200&q=80" alt="Prof. Sterling" class="bot-avatar">
                    <span class="message-sender">Prof. Sterling</span>
                </div>
                ${correctionHTML}
                <div class="message-content">${content}</div>
                <button class="translation-btn" title="Translate" onclick="translateMessage(this, '${content.replace(/'/g, "\\'")}')">
                    <i class="fas fa-language"></i>
                </button>
            `;
            
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            // Speak the bot's response
            speakText(content);
        }
        
        // Process user input and get bot response
        async function processUserInput(userText) {
            if (!userText.trim()) return;
            
            // Show typing indicator
            statusIndicator.textContent = 'Prof. Sterling está escribiendo...';
            
            try {
                // In a real implementation, you would call the Gemini API here
                // For this demo, we'll simulate responses
                await simulateGeminiAPI(userText);
            } catch (error) {
                console.error('Error processing input:', error);
                addBotMessage("I'm having trouble connecting right now. Please check your API key and try again.");
                statusIndicator.textContent = 'Error en la conexión';
            } finally {
                resetRecordingState();
            }
        }
        
        // Simulate Gemini API response (for demo purposes)
        async function simulateGeminiAPI(userText) {
            // Simulate API delay
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // Check for common errors in the user's text
            const corrections = checkForErrors(userText);
            
            // Generate a response based on the user's input
            let response = '';
            
            if (userText.toLowerCase().includes('hello') || userText.toLowerCase().includes('hi')) {
                response = `Hello ${userName}! How are you today? I'm here to help you practice your English.`;
            } else if (userText.toLowerCase().includes('how are you')) {
                response = "I'm doing well, thank you for asking! As an AI, I don't have feelings, but I'm always ready to help you learn English.";
            } else if (userText.toLowerCase().includes('music') || userText.toLowerCase().includes('song')) {
                response = "Music is a great topic! I enjoy classical music myself, but I also appreciate good pop and rock songs. What's your favorite genre?";
            } else if (userText.toLowerCase().includes('favorite')) {
                response = "That's interesting! I'm glad you shared that with me. Could you tell me more about why you like it?";
            } else if (userText.toLowerCase().includes('thank you')) {
                response = "You're very welcome! I'm happy to help you improve your English skills.";
            } else {
                response = `Thanks for sharing that, ${userName}. I appreciate you practicing English with me. Can you tell me more about your day or interests?`;
            }
            
            // Add the bot's response with corrections if any
            addBotMessage(response, corrections);
            statusIndicator.textContent = 'Presiona y mantén el micrófono para hablar';
        }
        
        // Check for common English errors in user text
        function checkForErrors(text) {
            const errorPatterns = [
                { 
                    pattern: /\bgender\b.*\bmusic\b/i, 
                    correction: "genre",
                    error: "gender of music",
                    correctionText: "genre of music"
                },
                { 
                    pattern: /\bi enjoyed\b.*\bit because that\b/i, 
                    correction: "I enjoy it because the",
                    error: "I enjoyed it because that",
                    correctionText: "I enjoy it because the"
                },
                { 
                    pattern: /\bi have went\b/i, 
                    correction: "I have gone",
                    error: "I have went",
                    correctionText: "I have gone"
                },
                { 
                    pattern: /\bshe don't\b/i, 
                    correction: "she doesn't",
                    error: "she don't",
                    correctionText: "she doesn't"
                },
                { 
                    pattern: /\bmore better\b/i, 
                    correction: "better",
                    error: "more better",
                    correctionText: "better"
                }
            ];
            
            for (const pattern of errorPatterns) {
                if (pattern.pattern.test(text)) {
                    return {
                        error: pattern.error,
                        correction: pattern.correctionText
                    };
                }
            }
            
            return null;
        }
        
        // Text-to-speech function
        function speakText(text) {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'en-US';
                utterance.rate = 1.0;
                utterance.pitch = 1.0;
                
                // Try to find a UK English voice for authenticity
                const voices = speechSynthesis.getVoices();
                const englishVoice = voices.find(voice => 
                    voice.lang.startsWith('en-') && voice.name.includes('Google')
                );
                
                if (englishVoice) {
                    utterance.voice = englishVoice;
                }
                
                speechSynthesis.speak(utterance);
            }
        }
        
        // Translate message (simulated for demo)
        function translateMessage(button, text) {
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            button.disabled = true;
            
            // Simulate translation API call
            setTimeout(() => {
                // In a real implementation, this would call a translation API
                // For demo, we'll just show a tooltip
                button.innerHTML = '<i class="fas fa-language"></i>';
                button.disabled = false;
                
                // Show a temporary notification
                const notification = document.createElement('div');
                notification.textContent = 'Traducción: ' + text.substring(0, 50) + '...';
                notification.style.cssText = `
                    position: fixed;
                    bottom: 120px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: var(--primary-color);
                    color: white;
                    padding: 10px 15px;
                    border-radius: var(--border-radius);
                    z-index: 1000;
                    max-width: 80%;
                    text-align: center;
                    box-shadow: var(--shadow);
                `;
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 3000);
            }, 500);
        }
        
        // Event Listeners
        micBtn.addEventListener('mousedown', () => {
            if (!isSendMode) {
                startRecording();
            }
        });
        
        micBtn.addEventListener('mouseup', () => {
            if (isRecording && !isSendMode) {
                // If recording and not in send mode, stop recording
                stopRecording();
            } else if (isSendMode) {
                // If in send mode, send the message
                const lastUserMessage = document.querySelector('.user-message:last-child .message-content');
                if (lastUserMessage) {
                    processUserInput(lastUserMessage.textContent);
                } else {
                    resetRecordingState();
                }
            }
        });
        
        // For touch devices
        micBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            if (!isSendMode) {
                startRecording();
            }
        });
        
        micBtn.addEventListener('touchend', (e) => {
            e.preventDefault();
            if (isRecording && !isSendMode) {
                stopRecording();
            } else if (isSendMode) {
                const lastUserMessage = document.querySelector('.user-message:last-child .message-content');
                if (lastUserMessage) {
                    processUserInput(lastUserMessage.textContent);
                } else {
                    resetRecordingState();
                }
            }
        });
        
        // Settings modal
        settingsBtn.addEventListener('click', () => {
            modalOverlay.classList.add('active');
        });
        
        closeModal.addEventListener('click', () => {
            modalOverlay.classList.remove('active');
        });
        
        saveSettings.addEventListener('click', () => {
            apiKey = apiKeyInput.value.trim();
            userName = userNameInput.value.trim() || 'Alejandro';
            
            // Save to localStorage
            localStorage.setItem('geminiApiKey', apiKey);
            localStorage.setItem('userName', userName);
            
            // Update UI if needed
            const userNames = document.querySelectorAll('.message-sender');
            userNames.forEach(el => {
                if (el.textContent === userNameInput.defaultValue || el.textContent === 'Alejandro') {
                    el.textContent = userName;
                }
            });
            
            modalOverlay.classList.remove('active');
            
            // Show confirmation
            statusIndicator.textContent = 'Configuración guardada correctamente';
            setTimeout(() => {
                statusIndicator.textContent = 'Presiona y mantén el micrófono para hablar';
            }, 2000);
        });
        
        // Close modal when clicking outside
        modalOverlay.addEventListener('click', (e) => {
            if (e.target === modalOverlay) {
                modalOverlay.classList.remove('active');
            }
        });
        
        // Initialize the app
        function initApp() {
            initFromStorage();
            
            // Add a welcome message after a short delay
            setTimeout(() => {
                addBotMessage(`Welcome ${userName}! I'm Professor Sterling, your AI English tutor. I'm here to help you practice English conversation. I'll listen to you speak and provide corrections when needed. Let's start with a simple question: How are you today?`);
            }, 1000);
        }
        
        // Initialize the app when page loads
        window.addEventListener('DOMContentLoaded', initApp);
        
        // For demo purposes, add some initial conversation
        window.addEventListener('load', () => {
            setTimeout(() => {
                addUserMessage("my favorite gender of music is rock or maybe pop and I enjoyed it because that songs have very interesting lyrics");
                setTimeout(() => {
                    const correction = {
                        error: "gender of music",
                        correction: "genre of music"
                    };
                    addBotMessage("Rock and pop are both excellent choices, Alejandro, and I completely agree about the captivating lyrics! As for me, I have a soft spot for classical music, though I also enjoy a good jazz standard now and then.", correction);
                }, 800);
            }, 2000);
        });
    </script>
</body>
</html>
