<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VoiceBot English Professor</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #1a237e 0%, #311b92 100%);
            color: #333;
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            width: 100%;
            max-width: 500px;
            background-color: #fff;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            height: 90vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: linear-gradient(to right, #5c6bc0, #3949ab);
            color: white;
            padding: 20px;
            display: flex;
            align-items: center;
            position: relative;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
        }

        .bot-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            overflow: hidden;
            margin-right: 15px;
            border: 3px solid rgba(255, 255, 255, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #7986cb;
        }

        .bot-avatar img {
            width: 70%;
            height: 70%;
            object-fit: contain;
            filter: brightness(0) invert(1);
        }

        .bot-info h1 {
            font-size: 1.5rem;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .bot-info p {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .settings-btn {
            position: absolute;
            right: 20px;
            top: 20px;
            background: transparent;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .settings-btn:hover {
            transform: rotate(30deg);
        }

        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background-color: #f5f5f5;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            max-width: 80%;
            padding: 15px;
            border-radius: 18px;
            position: relative;
            line-height: 1.4;
            word-break: break-word;
        }

        .bot-message {
            background-color: #e8eaf6;
            align-self: flex-start;
            border-bottom-left-radius: 5px;
            margin-right: auto;
        }

        .user-message {
            background-color: #3949ab;
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 5px;
            margin-left: auto;
        }

        .error-correction {
            background-color: #ffebee;
            border-left: 4px solid #f44336;
            padding: 10px 15px;
            margin-bottom: 5px;
            border-radius: 8px;
            font-size: 0.9rem;
        }

        .error-text {
            color: #d32f2f;
            font-weight: 600;
        }

        .correction-text {
            color: #388e3c;
            font-weight: 600;
        }

        .message-time {
            font-size: 0.7rem;
            opacity: 0.7;
            margin-top: 5px;
            text-align: right;
        }

        .translation-icon {
            position: absolute;
            bottom: -12px;
            right: 10px;
            font-size: 1rem;
            background: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            color: #3949ab;
        }

        .voice-controls {
            padding: 20px;
            background-color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            border-top: 1px solid #eee;
        }

        .mic-button {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: linear-gradient(to bottom, #5c6bc0, #3949ab);
            border: none;
            color: white;
            font-size: 1.8rem;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 5px 15px rgba(57, 73, 171, 0.4);
            transition: all 0.3s;
        }

        .mic-button:hover {
            transform: scale(1.05);
        }

        .mic-button.listening {
            background: linear-gradient(to bottom, #f44336, #d32f2f);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(244, 67, 54, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(244, 67, 54, 0); }
            100% { box-shadow: 0 0 0 0 rgba(244, 67, 54, 0); }
        }

        .sound-wave {
            display: flex;
            gap: 4px;
            height: 30px;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
        }

        .bar {
            width: 4px;
            background-color: #3949ab;
            border-radius: 2px;
            animation: sound-wave 1.5s ease infinite alternate;
        }

        .bar:nth-child(2) { animation-delay: 0.2s; }
        .bar:nth-child(3) { animation-delay: 0.4s; }
        .bar:nth-child(4) { animation-delay: 0.6s; }
        .bar:nth-child(5) { animation-delay: 0.8s; }

        @keyframes sound-wave {
            0% { height: 5px; }
            100% { height: 25px; }
        }

        .instructions {
            font-size: 0.9rem;
            color: #666;
            text-align: center;
            max-width: 80%;
        }

        .settings-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }

        .settings-content {
            background-color: white;
            border-radius: 15px;
            padding: 30px;
            width: 90%;
            max-width: 450px;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);
        }

        .settings-content h2 {
            margin-bottom: 20px;
            color: #3949ab;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .settings-content label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .settings-content input {
            width: 100%;
            padding: 12px 15px;
            margin-bottom: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
        }

        .settings-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 25px;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background-color: #3949ab;
            color: white;
        }

        .btn-secondary {
            background-color: #e0e0e0;
            color: #333;
        }

        .btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
            color: #666;
            margin-top: 10px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #ccc;
        }

        .status-dot.active {
            background-color: #4caf50;
            animation: blink 2s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @media (max-width: 768px) {
            .container {
                height: 95vh;
                border-radius: 15px;
            }
            
            .header {
                padding: 15px;
            }
            
            .bot-avatar {
                width: 50px;
                height: 50px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="bot-avatar">
                <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white'%3E%3Cpath d='M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z'/%3E%3C/svg%3E" alt="Bot Avatar">
            </div>
            <div class="bot-info">
                <h1>Profesora Clara</h1>
                <p>Tu profesor de inglés conversacional</p>
            </div>
            <button class="settings-btn" id="settingsBtn">
                <i class="fas fa-cog"></i>
            </button>
        </div>

        <div class="chat-container" id="chatContainer">
            <!-- Los mensajes aparecerán aquí -->
            <div class="message bot-message">
                <div class="error-correction" id="initialCorrection" style="display:none;">
                    <span class="error-text">Error: </span><span class="correction-text">Corrección: </span>
                </div>
                ¡Hola! Soy Clara, tu profesora de inglés personal. Estoy aquí para ayudarte a mejorar tu inglés conversacional. Cada vez que hables, revisaré tu pronunciación y gramática, y te señalaré los errores. ¿De qué te gustaría hablar hoy?
                <div class="message-time">12:00 PM</div>
                <div class="translation-icon">
                    <i class="fas fa-language"></i>
                </div>
            </div>
        </div>

        <div class="voice-controls">
            <div class="sound-wave" id="soundWave" style="display: none;">
                <div class="bar"></div>
                <div class="bar"></div>
                <div class="bar"></div>
                <div class="bar"></div>
                <div class="bar"></div>
            </div>
            <button class="mic-button" id="micButton">
                <i class="fas fa-microphone"></i>
            </button>
            <div class="instructions" id="instructions">
                Presiona el micrófono y habla en inglés
            </div>
            <div class="status-indicator">
                <div class="status-dot" id="statusDot"></div>
                <span id="statusText">Conectando...</span>
            </div>
        </div>
    </div>

    <div class="settings-modal" id="settingsModal">
        <div class="settings-content">
            <h2><i class="fas fa-cog"></i> Configuración</h2>
            <p>Para usar el bot, necesitas una API key de Google Gemini. Consíguela gratis en <a href="https://makersuite.google.com/app/apikey" target="_blank">Google AI Studio</a>.</p>
            
            <label for="apiKey">API Key de Gemini:</label>
            <input type="password" id="apiKey" placeholder="Ingresa tu API key">
            
            <label for="voiceSelect">Voz del asistente:</label>
            <select id="voiceSelect" class="btn" style="width:100%; padding:12px; margin-bottom:20px;">
                <option value="en-US-Neural2-J">Voz femenina (Estados Unidos)</option>
                <option value="en-GB-Neural2-A">Voz femenina (Reino Unido)</option>
                <option value="en-AU-Neural2-A">Voz femenina (Australia)</option>
            </select>
            
            <div class="settings-buttons">
                <button class="btn btn-secondary" id="closeSettings">Cancelar</button>
                <button class="btn btn-primary" id="saveSettings">Guardar</button>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let isListening = false;
        let recognition = null;
        let apiKey = '';
        let currentVoice = 'en-US-Neural2-J';
        let conversationHistory = [
            {
                role: "user",
                parts: [{ text: "Eres Clara, una profesora de inglés amable y paciente. Tu objetivo es ayudar a los estudiantes a mejorar su inglés conversacional. Debes responder en inglés, pero si el estudiante comete errores, debes señalarlos en español antes de tu respuesta. Los errores deben incluir correcciones de gramática, vocabulario y pronunciación. Mantén las respuestas breves y conversacionales. Presentate ahora." }]
            },
            {
                role: "model",
                parts: [{ text: "Hello! I'm Clara, your personal English teacher. I'm here to help you improve your conversational English. Whenever you speak, I'll check your pronunciation and grammar, and I'll point out any mistakes. What would you like to talk about today?" }]
            }
        ];

        // Elementos del DOM
        const micButton = document.getElementById('micButton');
        const chatContainer = document.getElementById('chatContainer');
        const soundWave = document.getElementById('soundWave');
        const instructions = document.getElementById('instructions');
        const settingsBtn = document.getElementById('settingsBtn');
        const settingsModal = document.getElementById('settingsModal');
        const closeSettings = document.getElementById('closeSettings');
        const saveSettings = document.getElementById('saveSettings');
        const apiKeyInput = document.getElementById('apiKey');
        const voiceSelect = document.getElementById('voiceSelect');
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');

        // Inicializar la aplicación
        function initApp() {
            // Cargar configuraciones guardadas
            const savedApiKey = localStorage.getItem('englishTeacherApiKey');
            const savedVoice = localStorage.getItem('englishTeacherVoice');
            
            if (savedApiKey) {
                apiKey = savedApiKey;
                apiKeyInput.value = savedApiKey;
            }
            
            if (savedVoice) {
                currentVoice = savedVoice;
                voiceSelect.value = savedVoice;
            }
            
            updateStatus();
            
            // Configurar el reconocimiento de voz
            setupSpeechRecognition();
            
            // Configurar eventos
            micButton.addEventListener('click', toggleListening);
            settingsBtn.addEventListener('click', () => settingsModal.style.display = 'flex');
            closeSettings.addEventListener('click', () => settingsModal.style.display = 'none');
            saveSettings.addEventListener('click', saveSettingsFunc);
            
            // Cerrar modal al hacer clic fuera
            settingsModal.addEventListener('click', (e) => {
                if (e.target === settingsModal) {
                    settingsModal.style.display = 'none';
                }
            });
        }

        // Configurar reconocimiento de voz
        function setupSpeechRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = 'en-US';
                
                recognition.onstart = () => {
                    isListening = true;
                    micButton.classList.add('listening');
                    soundWave.style.display = 'flex';
                    instructions.textContent = 'Escuchando... habla ahora';
                    updateStatus();
                };
                
                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    addUserMessage(transcript);
                    processUserInput(transcript);
                };
                
                recognition.onerror = (event) => {
                    console.error('Error en reconocimiento de voz:', event.error);
                    instructions.textContent = 'Error: ' + event.error;
                    stopListening();
                };
                
                recognition.onend = () => {
                    stopListening();
                };
                
                updateStatus();
            } else {
                statusText.textContent = 'Reconocimiento de voz no compatible';
                micButton.disabled = true;
                micButton.style.opacity = '0.5';
                instructions.textContent = 'Tu navegador no soporta reconocimiento de voz';
            }
        }

        // Alternar escucha
        function toggleListening() {
            if (!recognition) return;
            
            if (isListening) {
                recognition.stop();
            } else {
                try {
                    recognition.start();
                } catch (error) {
                    console.error('Error al iniciar reconocimiento:', error);
                    instructions.textContent = 'Error al iniciar el micrófono';
                }
            }
        }

        // Detener escucha
        function stopListening() {
            isListening = false;
            micButton.classList.remove('listening');
            soundWave.style.display = 'none';
            instructions.textContent = 'Presiona el micrófono y habla en inglés';
            updateStatus();
        }

        // Actualizar estado de conexión
        function updateStatus() {
            if (!recognition) {
                statusDot.className = 'status-dot';
                statusText.textContent = 'Reconocimiento de voz no disponible';
                return;
            }
            
            if (apiKey) {
                statusDot.className = 'status-dot active';
                statusText.textContent = isListening ? 'Escuchando...' : 'Conectado y listo';
            } else {
                statusDot.className = 'status-dot';
                statusText.textContent = 'Configura tu API key para comenzar';
            }
        }

        // Guardar configuración
        function saveSettingsFunc() {
            apiKey = apiKeyInput.value.trim();
            currentVoice = voiceSelect.value;
            
            if (!apiKey) {
                alert('Por favor ingresa una API key de Gemini');
                return;
            }
            
            localStorage.setItem('englishTeacherApiKey', apiKey);
            localStorage.setItem('englishTeacherVoice', currentVoice);
            
            settingsModal.style.display = 'none';
            updateStatus();
            
            // Probar la API key
            testApiKey();
        }

        // Probar la API key
        async function testApiKey() {
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: "Responde con 'OK' si estás funcionando correctamente."
                            }]
                        }]
                    })
                });
                
                if (response.ok) {
                    addBotMessage("Configuración guardada correctamente. ¡Estoy lista para ayudarte con tu inglés!", false);
                } else {
                    throw new Error('API key inválida');
                }
            } catch (error) {
                alert('Error al conectar con la API. Verifica tu API key.');
                console.error('Error testing API key:', error);
            }
        }

        // Añadir mensaje del usuario
        function addUserMessage(text) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message user-message';
            
            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            messageDiv.innerHTML = `
                ${text}
                <div class="message-time">${time}</div>
            `;
            
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // Añadir mensaje del bot
        function addBotMessage(text, showCorrection = false, correctionText = '') {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message bot-message';
            
            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            let correctionHTML = '';
            if (showCorrection && correctionText) {
                const correctionParts = correctionText.split('|');
                if (correctionParts.length >= 2) {
                    correctionHTML = `
                        <div class="error-correction">
                            <span class="error-text">Error: ${correctionParts[0]}</span><br>
                            <span class="correction-text">Correction: ${correctionParts[1]}</span>
                        </div>
                    `;
                }
            }
            
            messageDiv.innerHTML = `
                ${correctionHTML}
                ${text}
                <div class="message-time">${time}</div>
                <div class="translation-icon">
                    <i class="fas fa-language"></i>
                </div>
            `;
            
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            // Leer el mensaje en voz alta
            speakText(text);
        }

        // Procesar entrada del usuario
        async function processUserInput(userText) {
            if (!apiKey) {
                addBotMessage("Por favor configura tu API key de Gemini en la configuración (icono del engranaje) para poder ayudarte.", false);
                return;
            }
            
            // Añadir el mensaje del usuario al historial
            conversationHistory.push({
                role: "user",
                parts: [{ text: userText }]
            });
            
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: conversationHistory,
                        generationConfig: {
                            temperature: 0.7,
                            topK: 1,
                            topP: 1,
                            maxOutputTokens: 2048,
                        },
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`Error en la API: ${response.status}`);
                }
                
                const data = await response.json();
                const botResponse = data.candidates[0].content.parts[0].text;
                
                // Extraer correcciones si existen (formato especial)
                let correctionText = '';
                let cleanResponse = botResponse;
                
                // Buscar patrones de corrección en la respuesta
                if (botResponse.includes('ERROR:')) {
                    const errorMatch = botResponse.match(/ERROR:(.*?)CORRECTION:(.*?)(?=\n|$)/s);
                    if (errorMatch) {
                        correctionText = `${errorMatch[1].trim()}|${errorMatch[2].trim()}`;
                        cleanResponse = botResponse.replace(/ERROR:.*?CORRECTION:.*?(?=\n|$)/s, '').trim();
                    }
                }
                
                // Añadir la respuesta del bot al historial
                conversationHistory.push({
                    role: "model",
                    parts: [{ text: botResponse }]
                });
                
                // Mostrar el mensaje del bot con corrección si existe
                addBotMessage(cleanResponse, !!correctionText, correctionText);
                
            } catch (error) {
                console.error('Error al procesar la solicitud:', error);
                
                // Respuesta de respaldo si la API falla
                const fallbackResponses = [
                    "I heard you say: '" + userText + "'. Remember to use complete sentences when practicing English.",
                    "That's interesting! Try to speak a bit more slowly to improve your pronunciation.",
                    "Good attempt! Let's practice some common phrases. Repeat after me: 'How are you today?'",
                    "I'm here to help you improve. Could you try to rephrase that using different vocabulary?"
                ];
                
                const randomResponse = fallbackResponses[Math.floor(Math.random() * fallbackResponses.length)];
                addBotMessage(randomResponse, false);
            }
        }

        // Sintetizar voz
        function speakText(text) {
            if ('speechSynthesis' in window) {
                // Limpiar texto para quitar marcadores de corrección
                const cleanText = text.replace(/ERROR:.*?CORRECTION:.*?(?=\n|$)/s, '').trim();
                
                const speech = new SpeechSynthesisUtterance(cleanText);
                speech.lang = 'en-US';
                speech.rate = 1.0;
                speech.pitch = 1.0;
                speech.volume = 1.0;
                
                // Intentar configurar una voz específica
                const voices = speechSynthesis.getVoices();
                const selectedVoice = voices.find(voice => voice.voiceURI === currentVoice);
                if (selectedVoice) {
                    speech.voice = selectedVoice;
                }
                
                speechSynthesis.speak(speech);
            }
        }

        // Inicializar la aplicación cuando se cargue la página
        document.addEventListener('DOMContentLoaded', initApp);
        
        // Cargar voces disponibles para síntesis de voz
        if ('speechSynthesis' in window) {
            speechSynthesis.onvoiceschanged = () => {
                // Voces cargadas
            };
        }
    </script>
</body>
</html>
